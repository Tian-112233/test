<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å£°æ§åœ°å›¾ (å¼ºåŠ›ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #0b1124; overflow: hidden; font-family: "Microsoft YaHei", sans-serif; }
        #map-container { width: 100%; height: 100%; }
        
        /* çŠ¶æ€æ˜¾ç¤ºé¢æ¿ */
        #status-panel {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 100; text-align: center; width: 90%; pointer-events: none;
        }
        #main-status {
            display: inline-block;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #555;
            color: #fff;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }
        /* è¯†åˆ«æˆåŠŸæ—¶çš„ç‰¹æ•ˆ */
        .status-success {
            border-color: #ffcc00 !important;
            color: #ffcc00 !important;
            transform: scale(1.1);
        }

        /* å¯åŠ¨æŒ‰é’® */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 200;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        #start-btn {
            padding: 20px 60px; font-size: 24px;
            background: linear-gradient(90deg, #0066ff, #00d0ff);
            color: white; border: none; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 30px rgba(0, 200, 255, 0.6);
            transition: transform 0.2s;
        }
        #start-btn:hover { transform: scale(1.05); }
        .tips { margin-top: 20px; color: #aaa; font-size: 14px; }
    </style>
</head>
<body>

    <div id="start-overlay">
        <button id="start-btn">ç‚¹å‡»å¯åŠ¨å£°æ§ç³»ç»Ÿ</button>
        <div class="tips">è¯·ç¡®ä¿æ‚¨ä½¿ç”¨çš„æ˜¯ Chrome æˆ– Edge æµè§ˆå™¨ï¼Œå¹¶å…è®¸éº¦å…‹é£æƒé™</div>
    </div>

    <div id="status-panel">
        <div id="main-status">ç­‰å¾…å¯åŠ¨...</div>
    </div>
    
    <div id="map-container"></div>

    <script>
        const myChart = echarts.init(document.getElementById('map-container'));
        let recognition;
        let lightTimer = null; // æ§åˆ¶ç†„ç­çš„å®šæ—¶å™¨

        // --- 1. æ‰©å……åçš„å›½å®¶åç§°æ˜ å°„è¡¨ (ç”¨äºåŒ¹é…è¯­éŸ³) ---
        // é”®(Key): EChartsåœ°å›¾é‡Œçš„è‹±æ–‡å
        // å€¼(Value): æ˜¾ç¤ºçš„ä¸­æ–‡å & è¯­éŸ³åŒ¹é…è¯
        const countryNameMap = {
            'China': 'ä¸­å›½', 'Taiwan': 'ä¸­å›½å°æ¹¾',
            'United States': 'ç¾å›½', 'Russia': 'ä¿„ç½—æ–¯', 'Japan': 'æ—¥æœ¬',
            'United Kingdom': 'è‹±å›½', 'France': 'æ³•å›½', 'Germany': 'å¾·å›½',
            'Canada': 'åŠ æ‹¿å¤§', 'Australia': 'æ¾³å¤§åˆ©äºš', 'India': 'å°åº¦',
            'Brazil': 'å·´è¥¿', 'Argentina': 'é˜¿æ ¹å»·', 'South Korea': 'éŸ©å›½', 
            'North Korea': 'æœé²œ', 'Italy': 'æ„å¤§åˆ©', 'Spain': 'è¥¿ç­ç‰™', 
            'Netherlands': 'è·å…°', 'Belgium': 'æ¯”åˆ©æ—¶', 'Switzerland': 'ç‘å£«', 
            'Sweden': 'ç‘å…¸', 'Ukraine': 'ä¹Œå…‹å…°', 'Turkey': 'åœŸè€³å…¶',
            'Iran': 'ä¼Šæœ—', 'Saudi Arabia': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', 'Egypt': 'åŸƒåŠ', 
            'Pakistan': 'å·´åŸºæ–¯å¦', 'Indonesia': 'å°åº¦å°¼è¥¿äºš', 'Vietnam': 'è¶Šå—', 
            'Thailand': 'æ³°å›½', 'Singapore': 'æ–°åŠ å¡', 'Mexico': 'å¢¨è¥¿å“¥',
            'Bulgaria': 'ä¿åŠ åˆ©äºš', 'Greece': 'å¸Œè…Š', 'Mongolia': 'è’™å¤', 
            'New Zealand': 'æ–°è¥¿å…°', 'Chile': 'æ™ºåˆ©', 'Peru': 'ç§˜é²', 
            'Israel': 'ä»¥è‰²åˆ—', 'Philippines': 'è²å¾‹å®¾', 'Poland': 'æ³¢å…°'
        };

        // --- 2. åŠ è½½åœ°å›¾æ•°æ® (ä¸­å›½è§†è§’ä¿®å¤ç‰ˆ) ---
        const statusDiv = document.getElementById('main-status');
        
        statusDiv.innerText = "æ­£åœ¨ä¸‹è½½åœ°å›¾æ•°æ®...";
        
        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json())
            .then(worldJson => {
                // ç§»ä½ç®—æ³•ï¼šæŠŠç¾æ´²æ¬åˆ°å³è¾¹ï¼Œå®ç°å¤ªå¹³æ´‹è§†è§’
                worldJson.features.forEach(feature => {
                    const geometry = feature.geometry;
                    const shiftCoord = (coord) => {
                        if (coord[0] < -30) coord[0] += 360;
                        return coord;
                    };
                    if (geometry.type === "Polygon") {
                        geometry.coordinates.forEach(ring => ring.forEach(shiftCoord));
                    } else if (geometry.type === "MultiPolygon") {
                        geometry.coordinates.forEach(poly => poly.forEach(ring => ring.forEach(shiftCoord)));
                    }
                });

                echarts.registerMap('world', worldJson);
                initMap(); // åˆå§‹åŒ–åœ°å›¾
                statusDiv.innerText = "åœ°å›¾å°±ç»ªï¼Œè¯·ç‚¹å‡»æŒ‰é’®å¯åŠ¨";
            })
            .catch(err => {
                statusDiv.innerText = "åœ°å›¾åŠ è½½å¤±è´¥ (ç½‘ç»œé—®é¢˜)";
                console.error(err);
            });

        // --- 3. é…ç½®åœ°å›¾æ ·å¼ (å¹³æ—¶ä¸æ˜¾ç¤ºåå­—ï¼Œé€‰ä¸­æ˜¾ç¤º) ---
        function initMap() {
            const option = {
                backgroundColor: '#0b1124',
                tooltip: { trigger: 'item', formatter: '{b}' }, 
                series: [{
                    type: 'map',
                    map: 'world',
                    roam: true,
                    zoom: 1.1,
                    center: [150, 30], // å¤ªå¹³æ´‹ä¸­å¿ƒ
                    
                    // ã€çŠ¶æ€1ã€‘é»˜è®¤çŠ¶æ€ï¼šåå­—éšè—ï¼Œæ·±è“
                    label: { show: false }, 
                    itemStyle: {
                        areaColor: '#1a2640', 
                        borderColor: '#455a84',
                        borderWidth: 1
                    },

                    // ã€çŠ¶æ€2ã€‘é€‰ä¸­çŠ¶æ€ (å£°æ§è§¦å‘)ï¼šåå­—æ˜¾ç¤ºï¼Œäº®é‡‘
                    selectedMode: 'multiple',
                    select: {
                        label: { show: true, color: '#000', fontWeight: 'bold', fontSize: 18 },
                        itemStyle: {
                            areaColor: '#ffcc00', 
                            borderColor: '#fff',
                            borderWidth: 2,
                            shadowColor: 'rgba(255, 215, 0, 1)', 
                            shadowBlur: 30 
                        }
                    },
                    nameMap: countryNameMap // æ³¨å…¥ä¸­æ–‡æ˜ å°„
                }]
            };
            myChart.setOption(option);
        }

        // --- 4. è¯­éŸ³è¯†åˆ«ç³»ç»Ÿ (æ ¸å¿ƒä¿®å¤éƒ¨åˆ†) ---
        
        // ç»‘å®šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('start-btn').onclick = function() {
            startVoiceSystem();
        };

        function startVoiceSystem() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚\nè¯·ä½¿ç”¨ Chrome æ¡Œé¢ç‰ˆæˆ– Edge æ¡Œé¢ç‰ˆã€‚");
                return;
            }

            // éšè—å¯åŠ¨å±‚
            document.getElementById('start-overlay').style.display = 'none';

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; // æ¯æ¬¡è¯†åˆ«ä¸€å¥ï¼Œç»“æŸåè‡ªåŠ¨é‡å¯
            recognition.interimResults = false;

            // ç›‘å¬å¼€å§‹
            recognition.onstart = function() {
                statusDiv.innerText = "ğŸ¤ æ­£åœ¨è†å¬... (è¯·è¯´ï¼šæˆ‘æ¥è‡ªä¿åŠ åˆ©äºš)";
                statusDiv.style.borderColor = "#00d0ff";
                statusDiv.style.color = "#fff";
                statusDiv.classList.remove('status-success');
            };

            // ç›‘å¬ç»“æœ
            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                console.log("è¯†åˆ«ç»“æœ:", text);
                handleVoiceCommand(text);
            };

            // ç›‘å¬ç»“æŸ (è‡ªåŠ¨é‡å¯ï¼Œå®ç°æŒç»­ç›‘å¬)
            recognition.onend = function() {
                // ç®€å•çš„é˜²æŠ–åŠ¨é‡å¯
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch(e) {
                        // å¿½ç•¥â€œå·²ç»å¼€å§‹â€çš„é”™è¯¯
                    }
                }, 200);
            };

            // ç›‘å¬é”™è¯¯
            recognition.onerror = function(event) {
                console.log("è¯­éŸ³é”™è¯¯:", event.error);
                if (event.error === 'not-allowed') {
                    statusDiv.innerText = "âš ï¸ éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨åœ°å€æ å…è®¸æƒé™ï¼";
                    statusDiv.style.borderColor = "red";
                }
            };

            // å¯åŠ¨!
            try {
                recognition.start();
            } catch(e) {
                console.log(e);
            }
        }

        // --- 5. æ ¸å¿ƒé€»è¾‘ï¼šåŒ¹é… -> å‘å…‰ -> 2ç§’ç†„ç­ ---
        function handleVoiceCommand(text) {
            let found = false;
            let targetNameCN = "";

            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼ˆå¦‚æœç”¨æˆ·è¯´è¯å¾ˆå¿«ï¼‰
            if (lightTimer) {
                clearTimeout(lightTimer);
                lightTimer = null;
            }

            // å…ˆç†„ç­å½“å‰æ‰€æœ‰çš„å…‰
            turnOffLights();

            // éå†å­—å…¸ï¼ŒæŸ¥æ‰¾åŒ¹é…çš„å›½å®¶
            // æ¯”å¦‚ text="æˆ‘æ¥è‡ªä¼Ÿå¤§çš„ä¸­å›½", å­—å…¸é‡Œæœ‰ "ä¸­å›½", åŒ¹é…æˆåŠŸ
            for (let engKey in countryNameMap) {
                let cnName = countryNameMap[engKey];
                if (text.includes(cnName)) {
                    found = true;
                    targetNameCN = cnName;
                    
                    // ç‚¹äº®åœ°å›¾ (ä¼ å…¥è‹±æ–‡ Key)
                    lightUp(engKey);

                    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ä¸­å›½ï¼Œè¦æŠŠå°æ¹¾ä¹Ÿç‚¹äº®
                    if (cnName === 'ä¸­å›½') {
                        lightUp('Taiwan');
                    }
                    break; // æ‰¾åˆ°ä¸€ä¸ªå°±åœæ­¢
                }
            }

            // UI åé¦ˆ
            if (found) {
                statusDiv.innerText = `ğŸ‘‹ æ¬¢è¿æ¥è‡ª ${targetNameCN} çš„æœ‹å‹ï¼`;
                statusDiv.classList.add('status-success'); // å˜è‰²ç‰¹æ•ˆ

                // ã€æ ¸å¿ƒéœ€æ±‚ã€‘2ç§’åè‡ªåŠ¨ç†„ç­
                lightTimer = setTimeout(() => {
                    turnOffLights(); // ç†„ç¯
                    statusDiv.innerText = "ğŸ¤ ç»§ç»­è†å¬ä¸­...";
                    statusDiv.classList.remove('status-success');
                }, 2000); 

            } else {
                statusDiv.innerText = `ğŸ¤” å¬åˆ°äº†: "${text}" (æœªè¯†åˆ«åˆ°å›½å®¶)`;
                // 1ç§’åæ¢å¤æç¤º
                setTimeout(() => {
                   if(statusDiv.innerText.includes("ğŸ¤”")) {
                       statusDiv.innerText = "ğŸ¤ æ­£åœ¨è†å¬...";
                   }
                }, 1000);
            }
        }

        // ç‚¹äº®
        function lightUp(name) {
            myChart.dispatchAction({ type: 'select', seriesIndex: 0, name: name });
            myChart.dispatchAction({ type: 'highlight', seriesIndex: 0, name: name });
        }

        // ç†„ç¯
        function turnOffLights() {
            myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 });
            myChart.dispatchAction({ type: 'downplay', seriesIndex: 0 });
        }

        // çª—å£ç¼©æ”¾
        window.onresize = function() { myChart.resize(); };

    </script>
</body>
</html>
