
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°æ§å…¨å®¶ç¦</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        @import url('https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Zcool+KuaiLe&display=swap');

        * { box-sizing: border-box; }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Zcool KuaiLe', cursive, 'Microsoft YaHei', sans-serif;
            background: linear-gradient(180deg, #E0F7FA 0%, #4DD0E1 100%);
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨é¢æ¿ */
        .header-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 500;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .gender-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            color: #333;
        }

        .toggle-btn {
            padding: 6px 15px;
            border-radius: 20px;
            border: 2px solid #ddd;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            background: #fff;
        }
        .toggle-btn.active.boy { background: #e3f2fd; color: #1976d2; border-color: #1976d2; }
        .toggle-btn.active.girl { background: #fce4ec; color: #c2185b; border-color: #c2185b; }

        .status-text {
            font-size: 14px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .mic-icon { width: 10px; height: 10px; background: #ccc; border-radius: 50%; }
        .mic-icon.on { background: #4caf50; animation: pulse 1s infinite; }

        /* --- èˆå°åŒºåŸŸ --- */
        .stage-container {
            flex: 1;
            width: 100%;
            overflow-x: auto;
            display: flex;
            align-items: flex-end;
            padding-bottom: 80px; 
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.6) transparent;
        }

        .stage-wrapper {
            display: flex;
            align-items: flex-end;
            /* ã€å…³é”®ä¿®æ”¹1ã€‘æ‹‰å¤§é—´è·ï¼Œç¡®ä¿ä¸é‡å  */
            gap: 30px; 
            padding: 0 50px;
            padding-top: 220px; 
            margin: 0 auto;
            min-width: max-content;
        }

        /* äººç‰©ç»„ä»¶ï¼ˆç‰©ç†å ä½æ¡†ï¼‰ */
        .person-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            /* ã€å…³é”®ä¿®æ”¹2ã€‘è®¾ç½®è¶³å¤Ÿçš„ç‰©ç†å®½åº¦ã€‚240px è¶³å¤Ÿå®¹çº³æœ€å®½çš„å‘å‹ */
            width: 240px; 
            flex-shrink: 0;
            transition: transform 0.3s;
            /* ä¿æŒ visible ä»¥é˜²ä¸‡ä¸€ï¼Œè™½ç„¶ç°åœ¨å®½åº¦å¤Ÿäº†åº”è¯¥ä¸ä¼šæº¢å‡º */
            overflow: visible; 
            z-index: 10;
        }
        
        .person-box:hover {
            z-index: 100;
        }

        .img-container {
            width: 100%; /* å æ»¡ 240px */
            height: 280px; 
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding: 0;
        }

        .avatar-img {
            /* å›å½’æ ‡å‡†è®¾ç½®ï¼Œå æ»¡å®¹å™¨ */
            width: 100%; 
            height: 100%;
            object-fit: contain; 
            object-position: bottom center;
            filter: drop-shadow(0 8px 10px rgba(0,0,0,0.15));
            transition: transform 0.3s;
        }

        /* æ°”æ³¡ */
        .bubble {
            position: absolute;
            top: 20px; 
            left: 50%;
            transform: translateX(-50%) scale(0.5);
            background: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            z-index: 200; 
            white-space: nowrap;
        }
        .bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%;
            transform: translateX(-50%);
            border-width: 6px 6px 0; border-style: solid;
            border-color: white transparent transparent transparent;
        }

        /* æŒ¥æ‰‹åŠ¨ç”» */
        .person-box.waving .avatar-img {
            animation: waveBody 1s ease-in-out infinite;
        }
        
        @keyframes waveBody {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-8deg); }
            75% { transform: rotate(8deg); }
        }

        .person-box.waving .bubble {
            opacity: 1;
            transform: translateX(-50%) scale(1);
            top: -20px; 
        }

        .name-card {
            margin-top: -10px;
            background: white;
            padding: 5px 16px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            border: 3px solid #4FC3F7;
            z-index: 150; 
            min-width: 80px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }

        .ground {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 70px;
            background: #81C784; border-top: 6px solid #66BB6A;
            z-index: 0; pointer-events: none;
        }

        .start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            color: white; cursor: pointer;
        }
        .start-overlay h1 { color: #FFD700; margin-bottom: 20px; font-size: 2.5em; }
        .start-overlay p { font-size: 1.2em; line-height: 1.8; }

        @keyframes pulse { 0% { opacity: 0.4; } 50% { opacity: 1; } 100% { opacity: 0.4; } }

        .debug-area {
            position: fixed; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.6); color: lime; padding: 10px;
            border-radius: 5px; font-size: 12px; pointer-events: none; z-index: 200;
        }
    </style>
</head>
<body>

<div id="app">
    <div class="start-overlay" v-if="!hasStarted" @click="startSystem">
        <h1>ğŸ™ï¸ ç‚¹å‡»ä»»æ„å¤„å¼€å§‹</h1>
        <p>1. è¯´â€œæˆ‘å®¶æœ‰Xå£äººâ€ &nbsp;&nbsp; 2. è¯´â€œè¿™æ˜¯XXâ€</p>
    </div>

    <div class="header-panel">
        <div class="gender-toggle">
            <span>æˆ‘æ˜¯:</span>
            <div class="toggle-btn" :class="{active: myGender==='Boy', boy: true}" @click="setGender('Boy')">ç”·ç”Ÿ ğŸ‘¦</div>
            <div class="toggle-btn" :class="{active: myGender==='Girl', girl: true}" @click="setGender('Girl')">å¥³ç”Ÿ ğŸ‘§</div>
        </div>
        <div class="status-text">
            <div class="mic-icon" :class="{on: isListening}"></div>
            <span>{{ statusMsg }}</span>
        </div>
    </div>

    <div class="stage-container" ref="stageRef">
        <div class="stage-wrapper">
            <div v-for="(p, idx) in people" :key="p.id" class="person-box" :class="{waving: p.isWaving}" :style="{zIndex: 10 + idx}">
                <div class="bubble">ä½ å¥½!</div>
                <div class="img-container">
                    <img :src="p.img" :key="p.img" class="avatar-img" @error="handleImgError(p, $event)">
                </div>
                <div class="name-card">{{ p.name }}</div>
            </div>
        </div>
    </div>

    <div class="ground"></div>

    <div class="debug-area" v-if="lastCommand">
        å¬åˆ°: "{{ lastCommand }}" <br>
        åŠ¨ä½œ: {{ debugAction }}
    </div>
</div>

<script>
const { createApp, ref, nextTick } = Vue;

createApp({
    setup() {
        const hasStarted = ref(false);
        const isListening = ref(false);
        const statusMsg = ref("ç­‰å¾…å¯åŠ¨...");
        const lastCommand = ref("");
        const debugAction = ref("æ— ");
        const myGender = ref("Boy");
        const people = ref([]);
        const stageRef = ref(null);

        const cnToNum = {
            'ä¸€':1, 'äºŒ':2, 'ä¸¤':2, 'ä¸‰':3, 'å››':4, 
            'äº”':5, 'æ— ':5, 'ä¼':5, 'èˆ':5, 
            'å…­':6, 'ä¸ƒ':7, 'å…«':8, 'ä¹':9, 'å':10
        };

        const getAvatar = (role, genderPreference, index = 0) => {
            const baseUrl = "https://api.dicebear.com/9.x/avataaars/svg";
            
            // --- ã€å…³é”®ä¿®æ”¹3ã€‘API å‚æ•°è°ƒæ•´ ---
            // scale=80: æ ‡å‡†ç¼©æ”¾ï¼Œé…åˆ 240px çš„å¤§å®¹å™¨ï¼Œè¶³å¤Ÿæ˜¾ç¤ºå®Œæ•´ä¸”ä¸å°ã€‚
            // translateY=10: ç¨å¾®ä¸‹ç§»ï¼Œç•™å‡ºé¡¶éƒ¨ç©ºé—´ã€‚
            let config = "backgroundType=solid&backgroundRotation=0&translateY=10&scale=80"; 
            
            const seed = `${role}_${index}_${Math.random()}`;

            // --- å¼ºåˆ¶ç‰¹å¾åŒ¹é… ---
            if (['çˆ·çˆ·', 'å¤–å…¬'].includes(role)) {
                return `${baseUrl}?seed=${seed}&${config}&top=winterHat01&hairColor=platinum&facialHair=beardMajestic&clothing=collarAndSweater&skinColor=light&accessories=prescription02`;
            }
            if (['å¥¶å¥¶', 'å¤–å©†'].includes(role)) {
                return `${baseUrl}?seed=${seed}&${config}&top=bigHair&hairColor=platinum&clothing=graphicShirt&accessories=prescription02&skinColor=light`;
            }
            if (role === 'çˆ¸çˆ¸') {
                return `${baseUrl}?seed=${seed}&${config}&top=shortHairShortFlat&hairColor=black&facialHair=beardMedium&clothing=blazerAndShirt&skinColor=light`;
            }
            if (role === 'å¦ˆå¦ˆ') {
                return `${baseUrl}?seed=${seed}&${config}&top=longHairCurvy&hairColor=brown&clothing=overall&skinColor=light&accessories=none`;
            }
            if (role === 'å“¥å“¥' || role === 'å¼Ÿå¼Ÿ') {
                return `${baseUrl}?seed=${seed}&${config}&top=shortHairTheCaesar&hairColor=brown&clothing=hoodie&skinColor=light&accessories=none`;
            }
            if (role === 'å§å§' || role === 'å¦¹å¦¹') {
                return `${baseUrl}?seed=${seed}&${config}&top=longHairStraight&hairColor=black&clothing=shirtCrewNeck&skinColor=light&accessories=none`;
            }
            if (role === 'æˆ‘') {
                if (genderPreference === 'Boy') {
                    return `${baseUrl}?seed=${seed}&${config}&top=shortHairDreads01&hairColor=black&clothing=hoodie&skinColor=light&accessories=wayfarers`;
                } else {
                    return `${baseUrl}?seed=${seed}&${config}&top=longHairBob&hairColor=black&clothing=shirtScoopNeck&skinColor=light&accessories=catEye`;
                }
            }
            if (role.includes('æœ‹å‹')) {
                const num = parseInt(role.replace('æœ‹å‹', '')) || (index + 1);
                if (num % 2 !== 0) {
                    return `${baseUrl}?seed=${seed}&${config}&top=shortHairFrizzle&hairColor=pastelPink&clothing=graphicShirt`;
                } else {
                    return `${baseUrl}?seed=${seed}&${config}&top=longHairMiaWallace&hairColor=auburn&clothing=overall`;
                }
            }

            return `${baseUrl}?seed=${seed}&${config}`;
        };

        const handleImgError = (person, e) => {
            console.log(`${person.name} å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢åˆ° Emoji æ¨¡å¼`);
            let emoji = 'ğŸ‘¤';
            const name = person.name;

            if (name.includes('çˆ·') || name.includes('å¤–å…¬')) emoji = 'ğŸ‘´';
            else if (name.includes('å¥¶') || name.includes('å¤–å©†')) emoji = 'ğŸ‘µ';
            else if (name === 'çˆ¸çˆ¸') emoji = 'ğŸ‘¨';
            else if (name === 'å¦ˆå¦ˆ') emoji = 'ğŸ‘©';
            else if (name.includes('å“¥') || name.includes('å¼Ÿ')) emoji = 'ğŸ‘¦';
            else if (name.includes('å§') || name.includes('å¦¹')) emoji = 'ğŸ‘§';
            else if (name === 'æˆ‘') emoji = myGender.value === 'Boy' ? 'ğŸ§‘â€ğŸ“' : 'ğŸ‘©â€ğŸ“';
            else if (name.includes('æœ‹å‹')) emoji = (person.id % 2 === 0) ? 'ğŸ‘±â€â™€ï¸' : 'ğŸ‘±';

            const svgContent = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                    <text y=".9em" font-size="90">${emoji}</text>
                </svg>
            `;
            const dataUri = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svgContent)))}`;
            e.target.src = dataUri;
        };

        const startSystem = () => {
            hasStarted.value = true;
            initRecognition();
            statusMsg.value = "è¯·è¯´ï¼šæˆ‘å®¶æœ‰Xå£äºº";
        };

        const setGender = (g) => {
            myGender.value = g;
            const meIndex = people.value.findIndex(p => p.name === 'æˆ‘');
            if (meIndex !== -1) {
                people.value[meIndex].img = getAvatar('æˆ‘', g, 0);
            }
        };

        const initRecognition = () => {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRecognition) return alert("è¯·ä½¿ç”¨ Chrome æˆ– Edge æµè§ˆå™¨");
            
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;

            recognition.onstart = () => { isListening.value = true; statusMsg.value = "æ­£åœ¨å¬..."; };
            recognition.onend = () => { if(hasStarted.value) recognition.start(); };
            
            recognition.onresult = (e) => {
                const text = e.results[e.results.length-1][0].transcript;
                lastCommand.value = text;
                parseCommand(text);
            };
            recognition.start();
        };

        const parseCommand = (text) => {
            const countMatch = text.match(/æœ‰(\d+|[ä¸€äºŒä¸¤ä¸‰å››äº”æ— ä¼å…­ä¸ƒå…«ä¹å]+)[å£ä¸ª]äºº/);
            if(countMatch) {
                let rawNum = countMatch[1];
                let num = parseInt(rawNum);
                if(isNaN(num)) num = cnToNum[rawNum] || 0;
                
                if (num > 0) updatePeople(num);
                return;
            }

            if (text.includes("æœ‹å‹")) {
                const numMatch = text.match(/æœ‹å‹(\d+|[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+)/);
                if (numMatch) {
                    let fNumStr = numMatch[1];
                    let fNum = parseInt(fNumStr);
                    if(isNaN(fNum)) fNum = cnToNum[fNumStr];
                    doWave(`æœ‹å‹${fNum}`, true); 
                    return;
                } else {
                    doWave("æœ‹å‹", false);
                    return;
                }
            }

            const introMatch = text.match(/è¿™æ˜¯(æˆ‘|çˆ¸çˆ¸|å¦ˆå¦ˆ|çˆ·çˆ·|å¥¶å¥¶|å¤–å…¬|å¤–å©†|å“¥å“¥|å¼Ÿå¼Ÿ|å§å§|å¦¹å¦¹)/);
            const introMatch2 = text.match(/è¿™æ˜¯æˆ‘(çˆ¸çˆ¸|å¦ˆå¦ˆ|çˆ·çˆ·|å¥¶å¥¶|å¤–å…¬|å¤–å©†|å“¥å“¥|å¼Ÿå¼Ÿ|å§å§|å¦¹å¦¹)/);
            
            let target = null;
            if(introMatch2) target = introMatch2[1];
            else if(introMatch) target = introMatch[1];
            
            if(text.includes("è¿™æ˜¯æˆ‘") && !introMatch2 && !text.includes("æœ‹å‹")) target = "æˆ‘";
            
            if(target) doWave(target, false);
        };

        const updatePeople = (count) => {
            const familyQueue = ['çˆ¸çˆ¸', 'å¦ˆå¦ˆ', 'çˆ·çˆ·', 'å¥¶å¥¶', 'å“¥å“¥', 'å§å§', 'å¼Ÿå¼Ÿ', 'å¦¹å¦¹'];
            const newList = [];
            let friendCount = 1;

            newList.push({
                id: 'me',
                name: 'æˆ‘',
                img: getAvatar('æˆ‘', myGender.value),
                isWaving: false
            });

            const remainingCount = count - 1;
            
            for(let i = 0; i < remainingCount; i++) {
                let name = "";
                if (i < familyQueue.length) {
                    name = familyQueue[i];
                } else {
                    name = `æœ‹å‹${friendCount}`;
                    friendCount++;
                }

                newList.push({
                    id: i,
                    name: name,
                    img: getAvatar(name, myGender.value, i), 
                    isWaving: false
                });
            }

            people.value = newList;
            nextTick(() => {
                if(stageRef.value) stageRef.value.scrollTo({ left: 0, behavior: 'smooth' });
            });
        };

        const doWave = (nameToFind, isExactMatch) => {
            debugAction.value = `å¯»æ‰¾: ${nameToFind}`;
            
            let p = null;
            if (isExactMatch) {
                p = people.value.find(person => person.name === nameToFind);
            } else {
                p = people.value.find(person => person.name.includes(nameToFind));
            }
            
            if(p) {
                p.isWaving = true;
                
                let gender = 'female';
                let pitch = 1;
                
                if(['çˆ¸çˆ¸','çˆ·çˆ·','å¤–å…¬','å“¥å“¥','ç”·','å¼Ÿ'].some(k=>p.name.includes(k))) {
                    gender = 'male'; pitch = 0.8;
                } else if (p.name === 'æˆ‘' && myGender.value === 'Boy') {
                    gender = 'male'; pitch = 1.1;
                }
                
                if (p.name.includes('æœ‹å‹')) { 
                     if (p.img.includes('clothing=graphicShirt')) {
                          gender = 'male'; pitch = 0.9;
                     } else {
                          gender = 'female'; pitch = 1.2;
                     }
                }

                speak("ä½ å¥½", gender, pitch);
                setTimeout(() => p.isWaving = false, 1500);
            } else {
                debugAction.value = `æœªæ‰¾åˆ°: ${nameToFind}`;
            }
        };

        const speak = (txt, gender='female', pitch=1) => {
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'zh-CN';
            u.pitch = pitch;
            window.speechSynthesis.speak(u);
        };

        return {
            hasStarted, isListening, statusMsg, lastCommand, debugAction,
            myGender, people, stageRef,
            startSystem, setGender, handleImgError
        };
    }
}).mount('#app');
</script>
</body>
</html>
