
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç”Ÿæ—¥å¿«ä¹</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body {
            margin: 0;
            background: #fff5f7;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; 
            overflow: hidden;
            font-family: 'Microsoft YaHei', "STHeiti", sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* çŠ¶æ€æç¤º UI */
        #ui-layer {
            position: fixed;
            top: 20px;
            text-align: center;
            z-index: 100;
            width: 100%;
            pointer-events: none;
        }
        #status-msg {
            display: inline-block;
            font-size: 1rem;
            color: #ff4081;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(255,64,129,0.2);
            border: 2px solid #ff4081;
            transition: all 0.3s;
        }

        /* å¯åŠ¨å±‚ */
        #start-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }
        #btn-go {
            margin-top: 30px;
            padding: 15px 40px;
            font-size: 1.4rem;
            background: #ff4081;
            border: none;
            border-radius: 50px;
            color: white;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(255, 64, 129, 0.6);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* è›‹ç³•åŒºåŸŸ */
        #cake-world {
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            /* æ‰‹æœºç«¯ä¿æŒå®Œç¾çš„ 22vh æŠ¬é«˜ä½ç½® */
            padding-bottom: 22vh; 
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 10;
            transform-origin: bottom center; 
            width: 100%;
        }

        /* è›‹ç³•å±‚æ ·å¼ */
        .layer {
            height: 0;
            border-radius: 15px;
            position: relative;
            transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: -2px;
            box-shadow: inset 0 -10px 20px rgba(0,0,0,0.1);
        }
        .layer.active {
            height: 65px; 
        }

        .drip {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 25px; 
            background: rgba(255,255,255,0.5);
            border-radius: 15px 15px 0 0;
            clip-path: polygon(0% 0%, 100% 0%, 100% 70%, 95% 100%, 90% 75%, 85% 100%, 80% 75%, 75% 100%, 70% 75%, 65% 100%, 60% 75%, 55% 100%, 50% 75%, 45% 100%, 40% 75%, 35% 100%, 30% 75%, 25% 100%, 20% 75%, 15% 100%, 10% 75%, 5% 100%, 0% 75%);
        }

        /* èœ¡çƒ›æ ·å¼ */
        .candle-box {
            position: absolute;
            top: -55px; 
            display: flex;
            gap: 10px;
            z-index: 50;
            pointer-events: none;
        }
        .candle {
            width: 14px; 
            height: 0;
            border-radius: 4px;
            position: relative;
            transition: height 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.2);
            background: repeating-linear-gradient(45deg, #fff, #fff 5px, #ffb1c1 5px, #ffb1c1 10px);
            border: 1px solid #f0f0f0;
        }
        .candle.active {
            height: 50px;
        }
        
        /* ç«è‹—åŠ¨ç”» */
        .flame {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%) scale(0);
            width: 14px;
            height: 22px;
            transition: transform 0.4s;
        }
        .candle.active .flame {
            transform: translateX(-50%) scale(1);
        }
        .flame-main {
            width: 100%;
            height: 100%;
            background: #ff9800;
            border-radius: 50% 50% 20% 20%;
            position: relative;
            animation: flicker 0.1s infinite alternate;
        }
        .flame-core {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 50%;
            background: #fff176;
            border-radius: 50%;
        }

        @keyframes flicker {
            from { transform: scale(1) rotate(-2deg); opacity: 0.8; }
            to { transform: scale(1.1) rotate(2deg); opacity: 1; }
        }

        /* æœ€ç»ˆæ–‡å­— - åŸºç¡€æ ·å¼ï¼ˆé€‚é…æ‰‹æœºï¼‰ */
        #final-text {
            position: fixed;
            top: 15%; 
            width: 100%;
            text-align: center;
            font-size: 15vw;
            font-weight: 900;
            color: #ff4081; 
            transform: scale(0);
            opacity: 0;
            transition: all 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.5);
            z-index: 200; 
            pointer-events: none;
            text-shadow: 3px 3px 0 #fff, 0 0 20px rgba(255,255,255,0.8);
            white-space: nowrap; 
        }

        /* å…³é”®ä¿®æ”¹ï¼šé’ˆå¯¹ç”µè„‘/å¹³æ¿å¤§å±å¹•çš„ç‰¹æ®Šé€‚é… */
        @media (min-width: 768px) {
            #final-text {
                top: 5%; /* ç”µè„‘ä¸Šå¾€ä¸Šæï¼Œç»™è›‹ç³•ç•™ä½ç½® */
                font-size: 10vw; /* ç”µè„‘ä¸Šå­—ä¸è¦å¤ªå¤§ï¼Œç¨å¾®æ”¶æ•›ä¸€ç‚¹ */
            }
        }
    </style>
</head>
<body>

<div id="start-overlay">
    <div style="font-size: 4rem; margin-bottom: 10px;">ğŸ‚</div>
    <h2 style="margin:0 0 10px 0;">å¼€å§‹è®¸æ„¿</h2>
    <p style="font-size: 1rem; line-height: 1.6; color: #ddd;">
        è¯·å¤§å£°è¯´å‡ºâ€œ<b>ç”Ÿæ—¥å¿«ä¹</b>â€<br>
        æ¯è¯´ä¸€æ¬¡ï¼Œè›‹ç³•ä¼šé•¿é«˜æˆ–ç‚¹äº®èœ¡çƒ›
    </p>
    <button id="btn-go">å¼€å§‹ä»ªå¼</button>
</div>

<div id="ui-layer">
    <div id="status-msg">å‡†å¤‡ä¸­...</div>
</div>

<div id="final-text">ç”Ÿæ—¥å¿«ä¹</div>

<div id="cake-world">
    <div class="candle-box" id="candle-box"></div>
</div>

<script>
    const CONFIG = {
        maxLayers: 6,
        maxCandles: 6,
        colors: ['#FF8A80', '#FFD180', '#FFFF8D', '#B39DDB', '#80D8FF', '#F8BBD0'],
        confettiColors: ['#ff4081', '#ffeb3b', '#03a9f4', '#4caf50', '#ff9800', '#9c27b0', '#ffffff', '#e91e63']
    };

    let state = {
        layers: 0,
        candles: 0,
        finished: false,
        isLocked: false,
        audioContext: null,
        permissionDenied: false
    };

    const cakeWorld = document.getElementById('cake-world');
    const candleBox = document.getElementById('candle-box');
    const statusMsg = document.getElementById('status-msg');
    const finalText = document.getElementById('final-text');

    // 1. åˆå§‹åŒ–å…¥å£
    document.getElementById('btn-go').addEventListener('click', () => {
        document.getElementById('start-overlay').style.opacity = '0';
        setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500);
        
        initAudio();
        startVoiceRecognition();
        enableTouchAudioOnly();
    });

    // 2. æ ¸å¿ƒé€»è¾‘ï¼šæ‰§è¡Œä¸€æ­¥åŠ¨ä½œ
    function executeOneStep() {
        if (state.isLocked || state.finished) return;
        
        state.isLocked = true;
        playNoteSound(); 

        if (state.layers < CONFIG.maxLayers) {
            statusMsg.innerText = "âœ¨ è›‹ç³•é•¿é«˜å•¦ï¼";
            addOneLayer();
        } else if (state.candles < CONFIG.maxCandles) {
            statusMsg.innerText = "ğŸ•¯ï¸ èœ¡çƒ›ç‚¹äº®å•¦ï¼";
            addOneCandle();
        }

        setTimeout(() => {
            if (!state.finished) {
                state.isLocked = false;
                statusMsg.innerText = state.layers < CONFIG.maxLayers ? 
                    `è¯·å¤§å£°è¯´: ç”Ÿæ—¥å¿«ä¹ (${state.layers}/${CONFIG.maxLayers})` : 
                    `è¯·å¤§å£°è¯´: ç”Ÿæ—¥å¿«ä¹ (${state.candles}/${CONFIG.maxCandles})`;
            }
        }, 800);
    }

    // 3. è¯­éŸ³è¯†åˆ«é€»è¾‘
    function startVoiceRecognition() {
        const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
        
        if (!SpeechRecognition) {
            statusMsg.innerText = "âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³";
            alert("æŠ±æ­‰ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒWeb Speech APIã€‚è¯·ä½¿ç”¨Chromeæˆ–Safariã€‚");
            return;
        }

        const recognition = new SpeechRecognition();
        recognition.lang = 'zh-CN';
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onstart = () => {
            statusMsg.innerText = "ğŸ¤ è†å¬ä¸­...è¯·è¯´â€œç”Ÿæ—¥å¿«ä¹â€";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            console.log('æ”¶åˆ°è¯­éŸ³:', transcript); 
            if (transcript.match(/ç”Ÿæ—¥|å¿«ä¹|å¿«|ä¹|happy|birthday|è®¸æ„¿|ä»ªå¼/i)) {
                executeOneStep();
            }
        };

        recognition.onerror = (event) => {
            console.warn("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
            if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                statusMsg.innerText = "ğŸ”‡ éº¦å…‹é£æƒé™å·²æ‹’ç»";
                state.permissionDenied = true;
            } else {
                statusMsg.innerText = "ğŸ¤ æ²¡å¬æ¸…ï¼Œè¯·å¤§å£°ä¸€ç‚¹";
            }
        };

        recognition.onend = () => {
            if (!state.finished && !state.permissionDenied) {
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.log("é‡è¿è¯­éŸ³å¤±è´¥");
                    }
                }, 300);
            }
        };

        try {
            recognition.start();
        } catch(e) {
            state.permissionDenied = true;
            statusMsg.innerText = "âŒ è¯­éŸ³å¯åŠ¨å¤±è´¥";
        }
    }

    // 4. è§¦æ§è¾…åŠ©
    function enableTouchAudioOnly() {
        const resumeAudio = () => {
            if (state.audioContext && state.audioContext.state === 'suspended') {
                state.audioContext.resume();
            }
        };
        document.body.addEventListener('click', resumeAudio);
        document.body.addEventListener('touchstart', resumeAudio, {passive: true});
    }

    // 5. åŠ¨ç”»å‡½æ•°
    function addOneLayer() {
        state.layers++;
        const l = document.createElement('div');
        l.className = 'layer';
        l.style.backgroundColor = CONFIG.colors[state.layers - 1];
        
        // å®½åº¦è®¾ç½®ï¼šæœ€å¤§å®½åº¦450pxï¼Œæ‰‹æœºç«¯å æ¯”85%
        const baseWidth = Math.min(window.innerWidth * 0.85, 450);
        l.style.width = (baseWidth - state.layers * 30) + 'px';
        l.style.zIndex = 10 - state.layers;
        
        const drip = document.createElement('div');
        drip.className = 'drip';
        l.appendChild(drip);
        
        cakeWorld.appendChild(l);
        cakeWorld.appendChild(candleBox); 

        setTimeout(() => l.classList.add('active'), 50);
        
        // æ¯æ¬¡å¢åŠ éƒ½æ£€æŸ¥å°ºå¯¸
        if (state.layers > 1) {
            adjustCakeSize();
        }
    }

    function addOneCandle() {
        state.candles++;
        const c = document.createElement('div');
        c.className = 'candle';
        const f = document.createElement('div');
        f.className = 'flame';
        f.innerHTML = '<div class="flame-main"><div class="flame-core"></div></div>';
        c.appendChild(f);
        candleBox.appendChild(c);

        setTimeout(() => c.classList.add('active'), 50);
        
        if (state.candles === CONFIG.maxCandles) {
            finishEverything();
        }
    }
    
    // ä¸“é—¨ç”¨äºè°ƒæ•´è›‹ç³•å¤§å°çš„å‡½æ•° - çº¯å‡€ç‰ˆï¼ˆä¸ä½ç§»ï¼‰
    function adjustCakeSize() {
        // ä»…ä»…æ ¹æ®å±‚æ•°åšæå°çš„ç¼©æ”¾ï¼Œä¿è¯ä¸é¡¶å‡ºå±å¹•ï¼Œä½†ç»ä¸æ”¹å˜ä½ç½®
        const scaleFactor = 0.05; 
        let calcScale = 1 - (state.layers - 1) * scaleFactor;
        
        // é™åˆ¶æœ€å°ç¼©æ”¾æ¯”ä¾‹ä¸º 0.8ï¼Œä¿è¯è›‹ç³•è¶³å¤Ÿå¤§
        if (calcScale < 0.8) calcScale = 0.8;

        // åªç¼©æ”¾ï¼Œä¸ä½ç§»
        cakeWorld.style.transform = `scale(${calcScale})`;
    }

    // 6. ç»“æŸåº†å…¸
    function finishEverything() {
        if(state.finished) return;
        state.finished = true;
        
        statusMsg.style.display = 'none';
        
        // æ˜¾ç¤ºæ–‡å­—
        finalText.style.opacity = '1';
        finalText.style.transform = 'scale(1)';

        // æ’­æ”¾éŸ³ä¹å’Œæ’’èŠ±
        playFullBirthdaySong();
        startConfetti();
    }

    function startConfetti() {
        const duration = 15000;
        const animationEnd = Date.now() + duration;
        
        (function frame() {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return;
            
            const confettiConfig = {
                particleCount: 5,
                spread: 55,
                colors: CONFIG.confettiColors,
                zIndex: 9999, 
                disableForReducedMotion: true
            };

            confetti({
                ...confettiConfig,
                angle: 60,
                origin: { x: 0, y: 0.7 }
            });
            confetti({
                ...confettiConfig,
                angle: 120,
                origin: { x: 1, y: 0.7 }
            });
            
            requestAnimationFrame(frame);
        }());
    }

    // 7. éŸ³é¢‘å¤„ç†
    function initAudio() {
        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const osc = state.audioContext.createOscillator();
        const gain = state.audioContext.createGain();
        gain.gain.value = 0;
        osc.connect(gain);
        gain.connect(state.audioContext.destination);
        osc.start();
        osc.stop(0.1);
    }

    function playNoteSound() {
        if(!state.audioContext) return;
        const osc = state.audioContext.createOscillator();
        const gain = state.audioContext.createGain();
        osc.frequency.value = 400 + (state.layers * 50) + (state.candles * 100);
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.1, state.audioContext.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, state.audioContext.currentTime + 0.3);
        osc.connect(gain);
        gain.connect(state.audioContext.destination);
        osc.start();
        osc.stop(state.audioContext.currentTime + 0.3);
    }

    function playFullBirthdaySong() {
        if(!state.audioContext) return;
        const ctx = state.audioContext;
        
        const notes = {
            '5_': 392.00, '6_': 440.00, '7_': 493.88,
            '1': 523.25, '2': 587.33, '3': 659.25,
            '4': 698.46, '5': 783.99, '6': 880.00
        };

        const song = [
            ['5_', 300], ['5_', 300], ['6_', 600], ['5_', 600], ['1', 600], ['7_', 1000],
            ['5_', 300], ['5_', 300], ['6_', 600], ['5_', 600], ['2', 600], ['1', 1000],
            ['5_', 300], ['5_', 300], ['5', 600], ['3', 600], ['1', 600], ['7_', 600], ['6_', 1000],
            ['4', 300], ['4', 300], ['3', 600], ['1', 600], ['2', 600], ['1', 1200]
        ];

        let time = ctx.currentTime + 0.5;
        
        song.forEach((note) => {
            const freq = notes[note[0]];
            const duration = note[1] / 1000;
            const gap = 0.05;

            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(freq, time);
            
            gain.gain.setValueAtTime(0, time);
            gain.gain.linearRampToValueAtTime(0.3, time + 0.05);
            gain.gain.setValueAtTime(0.3, time + duration - 0.1);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration);

            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.start(time);
            osc.stop(time + duration);
            
            time += duration + gap;
        });
    }
</script>
</body>
</html>
