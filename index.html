<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声控地图 (纯净发光版)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #0b1124; overflow: hidden; font-family: "Microsoft YaHei", sans-serif; }
        #map-container { width: 100%; height: 100%; }
        
        /* 状态栏：简单朴素，绝对不发光 */
        #status-bar { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            z-index: 100; pointer-events: none; 
            color: #aaa; font-size: 16px; background: rgba(0,0,0,0.5); 
            padding: 5px 15px; border-radius: 4px;
        }

        /* 启动按钮 */
        #start-btn { 
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); 
            z-index: 200; padding: 15px 50px; 
            background: #007bff; color: white; border: none; border-radius: 30px; 
            font-size: 18px; cursor: pointer; 
        }
        #start-btn:active { transform: translateX(-50%) scale(0.95); }
    </style>
</head>
<body>

    <div id="status-bar">等待指令...</div>
    <div id="map-container"></div>
    <button id="start-btn">点击开启声控</button>

    <script>
        const myChart = echarts.init(document.getElementById('map-container'));
        let recognition;
        let lightTimer = null;

        // 1. 国家中英文对照表 (用于全量识别)
        const countryNameMap = {
            'China': '中国', 'Taiwan': '中国台湾',
            'United States': '美国', 'Russia': '俄罗斯', 'Japan': '日本',
            'United Kingdom': '英国', 'France': '法国', 'Germany': '德国',
            'Canada': '加拿大', 'Australia': '澳大利亚', 'India': '印度',
            'Brazil': '巴西', 'Argentina': '阿根廷', 'South Korea': '韩国', 
            'North Korea': '朝鲜', 'Italy': '意大利', 'Spain': '西班牙', 
            'Netherlands': '荷兰', 'Belgium': '比利时', 'Switzerland': '瑞士', 
            'Sweden': '瑞典', 'Ukraine': '乌克兰', 'Turkey': '土耳其',
            'Iran': '伊朗', 'Saudi Arabia': '沙特阿拉伯', 'Egypt': '埃及', 
            'Pakistan': '巴基斯坦', 'Indonesia': '印度尼西亚', 'Vietnam': '越南', 
            'Thailand': '泰国', 'Singapore': '新加坡', 'Mexico': '墨西哥',
            'Bulgaria': '保加利亚', 'Greece': '希腊', 'Mongolia': '蒙古', 
            'New Zealand': '新西兰', 'Chile': '智利', 'Peru': '秘鲁', 
            'Philippines': '菲律宾', 'Poland': '波兰', 'South Africa': '南非'
        };

        // 2. 加载并处理地图 (中国视角)
        myChart.showLoading({ text: '地图加载中...', color: '#ffcc00', textColor: '#fff' });

        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json())
            .then(worldJson => {
                // 移位算法：美洲移至右侧
                worldJson.features.forEach(feature => {
                    const geometry = feature.geometry;
                    const shiftCoord = (coord) => {
                        if (coord[0] < -30) coord[0] += 360;
                        return coord;
                    };
                    if (geometry.type === "Polygon") {
                        geometry.coordinates.forEach(ring => ring.forEach(shiftCoord));
                    } else if (geometry.type === "MultiPolygon") {
                        geometry.coordinates.forEach(poly => poly.forEach(ring => ring.forEach(shiftCoord)));
                    }
                });

                echarts.registerMap('world', worldJson);
                myChart.hideLoading();
                initMap();
                initSpeech();
            });

        // 3. 地图配置 (核心：发光样式)
        function initMap() {
            const option = {
                backgroundColor: '#0b1124', // 深蓝背景
                tooltip: { show: false }, // 关闭鼠标提示，保持干净
                series: [{
                    type: 'map',
                    map: 'world',
                    roam: true,
                    zoom: 1.1,
                    center: [150, 30], // 太平洋中心
                    
                    // --- 平时状态 ---
                    label: { show: false }, // 平时不显示名字
                    itemStyle: {
                        areaColor: '#1a2640', // 板块深蓝色
                        borderColor: '#455a84',
                        borderWidth: 1
                    },

                    // --- 选中(发光)状态 ---
                    selectedMode: 'multiple',
                    select: {
                        // 1. 名字显示出来，且为中文
                        label: { show: true, color: '#fff', fontWeight: 'bold', fontSize: 18 },
                        // 2. 地图板块变成金色发光
                        itemStyle: {
                            areaColor: '#ffcc00', // 主体金色
                            borderColor: '#fff',  // 边框亮白
                            borderWidth: 2,
                            shadowColor: 'rgba(255, 204, 0, 1)', // 强烈的金色光晕
                            shadowBlur: 50 // 光晕范围极大
                        }
                    },
                    nameMap: countryNameMap // 注入中文映射
                }]
            };
            myChart.setOption(option);
        }

        // 4. 语音识别逻辑
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("浏览器不支持语音，请使用 Chrome 或 Edge。");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; 
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                document.getElementById('status-bar').innerText = `识别到: ${text}`;
                processVoice(text);
            };

            recognition.onend = () => {
                // 自动重启监听
                try { recognition.start(); } catch(e) {}
            };

            document.getElementById('start-btn').onclick = function() {
                try {
                    recognition.start();
                    this.style.display = 'none'; // 隐藏按钮
                    document.getElementById('status-bar').innerText = "正在聆听...";
                } catch(e) {}
            };
        }

        // 5. 核心：匹配 -> 发光 -> 2秒熄灭
        function processVoice(text) {
            // 清除旧定时器
            if (lightTimer) {
                clearTimeout(lightTimer);
                lightTimer = null;
            }

            // 先全部熄灭
            myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 });

            // 遍历字典查找国家
            let found = false;
            for (let engKey in countryNameMap) {
                let cnName = countryNameMap[engKey];
                
                if (text.includes(cnName)) {
                    found = true;
                    // 点亮地图
                    highlightMap(engKey);
                    
                    // 中国特别处理
                    if (cnName === '中国') highlightMap('Taiwan');
                    
                    // 找到一个就退出循环（防止误判）
                    break;
                }
            }

            // 如果找到了，设置2秒后熄灭
            if (found) {
                lightTimer = setTimeout(() => {
                    myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 }); // 熄灯
                    document.getElementById('status-bar').innerText = "正在聆听...";
                }, 2000);
            }
        }

        function highlightMap(name) {
            // 触发 ECharts 的 select 状态 (对应上面的 select 样式)
            myChart.dispatchAction({
                type: 'select',
                seriesIndex: 0,
                name: name
            });
        }

        window.onresize = () => myChart.resize();
    </script>
</body>
</html>
