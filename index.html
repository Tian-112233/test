<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°æ§ä¸­å›½ç‰ˆä¸–ç•Œåœ°å›¾ (è‡ªåŠ¨ç†„ç­+å…¨è¯†åˆ«ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #0b1124;
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
        }

        #map-container {
            width: 100%;
            height: 100%;
        }

        /* çŠ¶æ€æ˜¾ç¤ºæ  */
        #status-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            pointer-events: none;
        }

        #voice-msg {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00d0ff;
            color: #00d0ff;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 208, 255, 0.3);
            transition: all 0.3s;
        }

        /* æŒ‰é’®æ ·å¼ */
        #start-btn {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            padding: 15px 50px;
            background: linear-gradient(135deg, #0066ff, #00ccff);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 150, 255, 0.5);
            transition: transform 0.1s;
        }

        #start-btn:active { transform: translateX(-50%) scale(0.95); }
    </style>
</head>
<body>

    <div id="status-bar">
        <div id="voice-msg">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’® -> å…è®¸éº¦å…‹é£ -> è¯´å‡ºå›½å®¶å</div>
    </div>
    
    <div id="map-container"></div>
    <button id="start-btn">ç‚¹å‡»å¼€å¯å£°æ§</button>

    <script>
        const myChart = echarts.init(document.getElementById('map-container'));
        let recognition;
        let highlightTimer = null; // ç”¨äºæ§åˆ¶2ç§’ç†„ç­çš„è®¡æ—¶å™¨

        // === å®Œæ•´çš„å›½å®¶ä¸­è‹±æ–‡æ˜ å°„è¡¨ (ç”¨äºè¦†ç›–ç»å¤§å¤šæ•°å›½å®¶) ===
        const countryNameMap = {
            'China': 'ä¸­å›½',
            'United States': 'ç¾å›½',
            'Russia': 'ä¿„ç½—æ–¯',
            'Japan': 'æ—¥æœ¬',
            'United Kingdom': 'è‹±å›½',
            'France': 'æ³•å›½',
            'Germany': 'å¾·å›½',
            'Canada': 'åŠ æ‹¿å¤§',
            'Australia': 'æ¾³å¤§åˆ©äºš',
            'India': 'å°åº¦',
            'Brazil': 'å·´è¥¿',
            'South Korea': 'éŸ©å›½',
            'North Korea': 'æœé²œ',
            'Pakistan': 'å·´åŸºæ–¯å¦',
            'Italy': 'æ„å¤§åˆ©',
            'Spain': 'è¥¿ç­ç‰™',
            'Ukraine': 'ä¹Œå…‹å…°',
            'Turkey': 'åœŸè€³å…¶',
            'Iran': 'ä¼Šæœ—',
            'Iraq': 'ä¼Šæ‹‰å…‹',
            'Afghanistan': 'é˜¿å¯Œæ±—',
            'Vietnam': 'è¶Šå—',
            'Thailand': 'æ³°å›½',
            'Indonesia': 'å°åº¦å°¼è¥¿äºš',
            'Malaysia': 'é©¬æ¥è¥¿äºš',
            'Philippines': 'è²å¾‹å®¾',
            'Singapore': 'æ–°åŠ å¡',
            'Mexico': 'å¢¨è¥¿å“¥',
            'Argentina': 'é˜¿æ ¹å»·',
            'Chile': 'æ™ºåˆ©',
            'South Africa': 'å—é',
            'Egypt': 'åŸƒåŠ',
            'Saudi Arabia': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯',
            'Israel': 'ä»¥è‰²åˆ—',
            'Poland': 'æ³¢å…°',
            'Sweden': 'ç‘å…¸',
            'Norway': 'æŒªå¨',
            'Finland': 'èŠ¬å…°',
            'Netherlands': 'è·å…°',
            'Belgium': 'æ¯”åˆ©æ—¶',
            'Switzerland': 'ç‘å£«',
            'Austria': 'å¥¥åœ°åˆ©',
            'Greece': 'å¸Œè…Š',
            'Portugal': 'è‘¡è„ç‰™',
            'New Zealand': 'æ–°è¥¿å…°',
            'Mongolia': 'è’™å¤',
            'Kazakhstan': 'å“ˆè¨å…‹æ–¯å¦',
            'Bulgaria': 'ä¿åŠ åˆ©äºš',
            'Romania': 'ç½—é©¬å°¼äºš',
            'Hungary': 'åŒˆç‰™åˆ©',
            'Czech Republic': 'æ·å…‹',
            'Slovakia': 'æ–¯æ´›ä¼å…‹',
            'Belarus': 'ç™½ä¿„ç½—æ–¯',
            'Taiwan': 'ä¸­å›½å°æ¹¾' 
        };

        // 1. åŠ è½½å¹¶é‡æ„åœ°å›¾æ•°æ®
        myChart.showLoading({ text: 'æ­£åœ¨æ„å»ºåœ°å›¾...', color: '#00d0ff', textColor: '#fff' });

        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json())
            .then(worldJson => {
                // åœ°å›¾ç§»ä½ç®—æ³•ï¼šå¤ªå¹³æ´‹è§†è§’
                worldJson.features.forEach(feature => {
                    const geometry = feature.geometry;
                    const shiftCoord = (coord) => {
                        if (coord[0] < -30) coord[0] += 360;
                        return coord;
                    };
                    if (geometry.type === "Polygon") {
                        geometry.coordinates.forEach(ring => ring.forEach(shiftCoord));
                    } else if (geometry.type === "MultiPolygon") {
                        geometry.coordinates.forEach(poly => poly.forEach(ring => ring.forEach(shiftCoord)));
                    }
                });

                echarts.registerMap('world', worldJson);
                myChart.hideLoading();
                initMap();
                initSpeech();
            });

        // 2. åˆå§‹åŒ–åœ°å›¾é…ç½®
        function initMap() {
            const option = {
                backgroundColor: '#0b1124',
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}' 
                },
                series: [
                    {
                        type: 'map',
                        map: 'world',
                        roam: true,
                        zoom: 1.1,
                        center: [150, 30],
                        
                        // === å…³é”®ä¿®æ”¹1ï¼šé»˜è®¤ä¸æ˜¾ç¤ºåå­— ===
                        label: {
                            show: false, 
                            color: '#999'
                        },

                        // æ™®é€šæ ·å¼
                        itemStyle: {
                            areaColor: '#1a2640', 
                            borderColor: '#455a84',
                            borderWidth: 1
                        },

                        // æ‚¬åœæ ·å¼ (é¼ æ ‡æŒ‡ä¸Šå»æ˜¾ç¤ºåå­—)
                        emphasis: {
                            label: { show: true, color: '#fff' },
                            itemStyle: { areaColor: '#2a3f66' }
                        },

                        // === å…³é”®ä¿®æ”¹2ï¼šé€‰ä¸­/é«˜äº®æ ·å¼ (è¯­éŸ³è§¦å‘) ===
                        selectedMode: 'multiple', 
                        select: {
                            label: { 
                                show: true, // åªæœ‰è¢«ç‚¹äº®æ—¶æ‰æ˜¾ç¤ºåå­—
                                color: '#000', 
                                fontWeight: 'bold',
                                fontSize: 16
                            },
                            itemStyle: {
                                areaColor: '#ffcc00', 
                                borderColor: '#fff',
                                borderWidth: 2,
                                shadowColor: 'rgba(255, 204, 0, 1)', 
                                shadowBlur: 30
                            }
                        },

                        // æ³¨å…¥æ‰€æœ‰å›½å®¶çš„ä¸­æ–‡æ˜ å°„
                        nameMap: countryNameMap,
                        data: [] 
                    }
                ]
            };
            myChart.setOption(option);
            
            // ç‚¹å‡»åœ°å›¾ä¹Ÿèƒ½è§¦å‘åŒæ ·çš„é€»è¾‘
            myChart.on('click', function(params) {
                // å¦‚æœæ˜¯ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ï¼Œä¹Ÿæ‰§è¡Œ2ç§’åç†„ç­é€»è¾‘ï¼Œä¿æŒä½“éªŒä¸€è‡´
                highlightWithTimer(params.name);
            });
        }

        // 3. è¯­éŸ³è¯†åˆ«é€»è¾‘
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                document.getElementById('voice-msg').innerText = "æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ï¼Œè¯·ä½¿ç”¨ Chrome/Edge";
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; 
            recognition.interimResults = false;

            const msgBox = document.getElementById('voice-msg');
            const btn = document.getElementById('start-btn');

            recognition.onstart = function() {
                msgBox.innerText = "ğŸ¤ è†å¬ä¸­... è¯•ç€è¯´ï¼šç¾å›½ã€æ—¥æœ¬ã€å·´è¥¿";
                msgBox.style.color = "#fff";
                msgBox.style.borderColor = "#fff";
                btn.style.display = 'none';
            };

            recognition.onend = function() {
                try { recognition.start(); } catch(e) {}
            };

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                console.log("è¯†åˆ«ç»“æœ:", text);
                handleCommand(text);
            };

            btn.onclick = function() {
                try { recognition.start(); } catch(e) {}
            };
        }

        // 4. å¤„ç†æŒ‡ä»¤ (æ”¯æŒå…¨è¯†åˆ«)
        function handleCommand(text) {
            const msgBox = document.getElementById('voice-msg');
            let matchedCountry = null;

            // éå†æ˜ å°„è¡¨ï¼ŒæŸ¥æ‰¾è¯­éŸ³ä¸­æ˜¯å¦åŒ…å«æŸä¸ªå›½å®¶å
            // ä¾‹å¦‚ï¼štext="æˆ‘æ¥è‡ªæ„å¤§åˆ©" -> åŒ¹é…åˆ° "æ„å¤§åˆ©"
            for (let enName in countryNameMap) {
                const cnName = countryNameMap[enName];
                if (text.includes(cnName)) {
                    matchedCountry = cnName; // è®°å½•åŒ¹é…åˆ°çš„ä¸­æ–‡å
                    break;
                }
            }

            if (matchedCountry) {
                msgBox.innerText = `ğŸ‘‹ è¯†åˆ«åˆ°ï¼š${matchedCountry}`;
                msgBox.style.color = "#ffcc00";
                msgBox.style.borderColor = "#ffcc00";
                
                // æ‰§è¡Œé«˜äº®å¹¶å€’è®¡æ—¶
                highlightWithTimer(matchedCountry);
            } else {
                msgBox.innerText = `ğŸ¤” å¬åˆ°äº†: "${text}" (æœªåŒ¹é…)`;
                msgBox.style.color = "#00d0ff";
                msgBox.style.borderColor = "#00d0ff";
            }
        }

        // 5. é«˜äº®æ§åˆ¶æ ¸å¿ƒå‡½æ•° (å¸¦2ç§’è‡ªåŠ¨ç†„ç­)
        function highlightWithTimer(name) {
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢è¿ç»­è¯´è¯æ—¶é€»è¾‘æ··ä¹±
            if (highlightTimer) {
                clearTimeout(highlightTimer);
            }

            // å…ˆæ¸…é™¤æ‰€æœ‰ç°æœ‰çš„é«˜äº®
            myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 }); 
            myChart.dispatchAction({ type: 'downplay', seriesIndex: 0 }); 

            // ç‚¹äº®ç›®æ ‡
            myChart.dispatchAction({
                type: 'select',
                seriesIndex: 0,
                name: name
            });
            myChart.dispatchAction({
                type: 'highlight',
                seriesIndex: 0,
                name: name
            });

            // è®¾å®š2ç§’åç†„ç­
            highlightTimer = setTimeout(() => {
                myChart.dispatchAction({
                    type: 'unselect',
                    seriesIndex: 0,
                    name: name
                });
                myChart.dispatchAction({
                    type: 'downplay',
                    seriesIndex: 0,
                    name: name
                });
                
                // æ¢å¤çŠ¶æ€æ æ–‡å­—
                document.getElementById('voice-msg').innerText = "ğŸ¤ è¯·ç»§ç»­è¯´è¯...";
                document.getElementById('voice-msg').style.color = "#fff";
                document.getElementById('voice-msg').style.borderColor = "#fff";

            }, 2000); // 2000æ¯«ç§’ = 2ç§’
        }

        window.onresize = function() { myChart.resize(); };

    </script>
</body>
</html>
