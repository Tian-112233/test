<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声控地图 (强力调试版)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #0b1124; overflow: hidden; font-family: "Microsoft YaHei", sans-serif; }
        #map-container { width: 100%; height: 100%; }
        
        /* 调试面板：让你看到程序到底在干什么 */
        #debug-panel {
            position: absolute; top: 10px; left: 10px; z-index: 999;
            background: rgba(255, 0, 0, 0.2); border: 1px solid red; color: #ffaaaa;
            padding: 10px; font-size: 12px; pointer-events: none;
            max-width: 300px;
        }

        /* 状态提示 (屏幕中间) */
        #status-bar { 
            position: absolute; top: 50px; left: 50%; transform: translateX(-50%); 
            z-index: 100; pointer-events: none; 
            color: #fff; font-size: 18px; text-shadow: 0 0 5px #000;
        }

        /* 按钮 */
        #start-btn { 
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); 
            z-index: 200; padding: 15px 50px; 
            background: #007bff; color: white; border: none; border-radius: 30px; 
            font-size: 18px; cursor: pointer; 
        }
    </style>
</head>
<body>

    <div id="debug-panel">
        <div>系统状态: 等待启动...</div>
        <div id="log-listen">听到: -</div>
        <div id="log-match">匹配: -</div>
        <div id="log-action">动作: -</div>
    </div>

    <div id="status-bar">点击下方按钮开始</div>
    <div id="map-container"></div>
    <button id="start-btn">点击开启声控</button>

    <script>
        const myChart = echarts.init(document.getElementById('map-container'));
        let recognition;
        let lightTimer = null;
        
        // --- 1. 核心字典：确保这里的 Key (英文) 和地图数据里的 name 一模一样 ---
        const countryNameMap = {
            'China': '中国', 'Taiwan': '中国台湾',
            'United States': '美国', 'Russia': '俄罗斯', 'Japan': '日本',
            'United Kingdom': '英国', 'France': '法国', 'Germany': '德国',
            'Canada': '加拿大', 'Australia': '澳大利亚', 'India': '印度',
            'Brazil': '巴西', 'Argentina': '阿根廷', 'South Korea': '韩国', 
            'North Korea': '朝鲜', 'Italy': '意大利', 'Spain': '西班牙', 
            'Netherlands': '荷兰', 'Belgium': '比利时', 'Switzerland': '瑞士', 
            'Sweden': '瑞典', 'Ukraine': '乌克兰', 'Turkey': '土耳其',
            'Iran': '伊朗', 'Saudi Arabia': '沙特阿拉伯', 'Egypt': '埃及', 
            'Pakistan': '巴基斯坦', 'Indonesia': '印度尼西亚', 'Vietnam': '越南', 
            'Thailand': '泰国', 'Singapore': '新加坡', 'Mexico': '墨西哥',
            'Bulgaria': '保加利亚', 'Greece': '希腊', 'Mongolia': '蒙古', 
            'New Zealand': '新西兰', 'Chile': '智利', 'Peru': '秘鲁', 
            'Philippines': '菲律宾', 'Poland': '波兰', 'South Africa': '南非'
        };

        // --- 2. 加载地图 ---
        log("正在下载地图数据...");
        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json())
            .then(worldJson => {
                log("地图数据下载成功，正在处理...");
                
                // 移位算法 (中国视角)
                worldJson.features.forEach(feature => {
                    const geometry = feature.geometry;
                    const shiftCoord = (coord) => {
                        if (coord[0] < -30) coord[0] += 360;
                        return coord;
                    };
                    if (geometry.type === "Polygon") {
                        geometry.coordinates.forEach(ring => ring.forEach(shiftCoord));
                    } else if (geometry.type === "MultiPolygon") {
                        geometry.coordinates.forEach(poly => poly.forEach(ring => ring.forEach(shiftCoord)));
                    }
                });

                echarts.registerMap('world', worldJson);
                initMap();
                initSpeech();
                log("系统就绪，请点击按钮");
            });

        // --- 3. 地图配置 (强制高亮样式) ---
        function initMap() {
            const option = {
                backgroundColor: '#0b1124',
                tooltip: { show: false },
                series: [{
                    name: 'WorldMap', // 给系列起个名字，方便调用
                    type: 'map',
                    map: 'world',
                    roam: true,
                    zoom: 1.1,
                    center: [150, 30],
                    
                    // 默认样式
                    label: { show: false },
                    itemStyle: {
                        areaColor: '#1a2640',
                        borderColor: '#455a84',
                        borderWidth: 1
                    },

                    // 【核心】选中后的发光样式
                    selectedMode: 'multiple',
                    select: {
                        // 名字显示出来
                        label: { show: true, color: '#fff', fontSize: 18, fontWeight: 'bold' },
                        // 板块变亮
                        itemStyle: {
                            areaColor: '#ffcc00', // 亮黄色
                            borderColor: '#fff',
                            borderWidth: 2,
                            shadowColor: 'rgba(255, 204, 0, 1)', // 强光
                            shadowBlur: 50 // 光晕
                        }
                    },
                    nameMap: countryNameMap // 注入中文名字
                }]
            };
            myChart.setOption(option);
        }

        // --- 4. 语音处理 ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("不支持语音，请用 Chrome");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false;
            recognition.interimResults = false;

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                // 更新调试面板
                document.getElementById('log-listen').innerText = `听到: ${text}`;
                document.getElementById('status-bar').innerText = `识别中...`;
                
                processVoice(text);
            };

            recognition.onend = () => {
                try { recognition.start(); } catch(e) {}
                document.getElementById('status-bar').innerText = `正在聆听...`;
            };

            document.getElementById('start-btn').onclick = function() {
                try {
                    recognition.start();
                    this.style.display = 'none';
                    log("语音服务已启动");
                } catch(e) { console.log(e); }
            };
        }

        // --- 5. 核心：匹配逻辑 ---
        function processVoice(text) {
            if (lightTimer) { clearTimeout(lightTimer); lightTimer = null; }

            // 先把灯关了
            myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 });

            let matchedKey = null;
            let matchedCN = null;

            // 暴力轮询匹配
            for (let engKey in countryNameMap) {
                let cnName = countryNameMap[engKey];
                if (text.includes(cnName)) {
                    matchedKey = engKey;
                    matchedCN = cnName;
                    break;
                }
            }

            if (matchedKey) {
                // 更新调试面板
                document.getElementById('log-match').innerText = `匹配: ${matchedCN} -> ${matchedKey}`;
                document.getElementById('log-action').innerText = `动作: 发光指令已发送`;
                
                // 执行发光
                highlight(matchedKey);

                // 如果是中国，附赠台湾
                if (matchedCN === '中国') {
                    highlight('Taiwan');
                }

                // 2秒后熄灭
                lightTimer = setTimeout(() => {
                    myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 });
                    document.getElementById('log-action').innerText = `动作: 自动熄灭`;
                }, 2000);

            } else {
                document.getElementById('log-match').innerText = `匹配: 失败`;
                document.getElementById('log-action').innerText = `动作: 无`;
            }
        }

        function highlight(name) {
            // 这里使用了最稳妥的方式：直接根据 name 选中
            // 注意：这里的 name 必须是地图 JSON 里的英文名，不是 nameMap 后的中文名
            myChart.dispatchAction({
                type: 'select',
                seriesIndex: 0, 
                name: name 
            });
            // 额外加一层高亮保险
            myChart.dispatchAction({
                type: 'highlight',
                seriesIndex: 0, 
                name: name 
            });
        }

        function log(msg) {
            document.querySelector('#debug-panel div:first-child').innerText = `状态: ${msg}`;
        }

        window.onresize = () => myChart.resize();
    </script>
</body>
</html>
