<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声控中国版世界地图 (太平洋视角)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #0b1124; /* 深空蓝背景 */
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
        }

        #map-container {
            width: 100%;
            height: 100%;
        }

        /* 状态指示器 (仅显示简单的文字状态，不发光) */
        #status-panel {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            pointer-events: none;
        }

        #main-status {
            color: #fff;
            font-size: 20px;
            letter-spacing: 2px;
            background: rgba(0,0,0,0.6);
            padding: 10px 30px;
            border-radius: 4px;
            border: 1px solid #334b75;
        }

        /* 启动按钮 */
        #start-btn {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            padding: 15px 40px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
        }
        
        #start-btn:hover { background: #0056b3; }
        
        /* 错误提示 */
        #error-msg {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 999;
        }
    </style>
</head>
<body>

    <div id="status-panel">
        <div id="main-status">等待指令...</div>
    </div>
    
    <div id="error-msg"></div>
    <div id="map-container"></div>
    <button id="start-btn">点击启用声控 (支持 Edge/Chrome)</button>

    <script>
        const myChart = echarts.init(document.getElementById('map-container'));
        let recognition;

        // --- 核心步骤1：地图数据处理 (打造中国视角) ---
        // 我们下载标准地图，然后手动修改经度，把美洲移到右边
        myChart.showLoading({ text: '正在重构地图板块...', color: '#fff' });

        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json())
            .then(worldJson => {
                
                // === 关键算法：将地图切割线从太平洋移到大西洋 ===
                // 标准地图经度是 -180 到 180。
                // 我们把所有小于 -30 (大西洋位置) 的经度都加上 360。
                // 这样美洲 (-100) 就会变成 260 (在中国的右边)，实现太平洋视角。
                worldJson.features.forEach(feature => {
                    const geometry = feature.geometry;
                    const modifyCoord = (coord) => {
                        // 如果经度小于 -30 (大概在大西洋)，把它搬到右边去
                        if (coord[0] < -30) {
                            coord[0] += 360;
                        }
                        return coord;
                    };

                    if (geometry.type === "Polygon") {
                        geometry.coordinates.forEach(ring => ring.forEach(modifyCoord));
                    } else if (geometry.type === "MultiPolygon") {
                        geometry.coordinates.forEach(polygon => polygon.forEach(ring => ring.forEach(modifyCoord)));
                    }
                });
                // ============================================

                myChart.hideLoading();
                echarts.registerMap('world', worldJson);
                initMap();
                initSpeech();
            })
            .catch(err => {
                alert("地图加载失败，请检查网络");
            });

        // --- 核心步骤2：配置 ECharts ---
        function initMap() {
            const option = {
                backgroundColor: '#0b1124',
                geo: {
                    map: 'world',
                    roam: true, // 允许缩放
                    zoom: 1.1,
                    // 因为我们把美洲移到了右边(260)，中国在110，中心点大概在 150 左右
                    center: [150, 30], 
                    label: { show: false },
                    itemStyle: {
                        areaColor: '#1a2640', // 板块基础颜色 (深色)
                        borderColor: '#2a3b5e', // 边界线颜色
                        borderWidth: 1
                    },
                    // 这里定义“发光”的样式
                    select: {
                        label: { show: false }, // 选中时不显示文字，保持干净
                        itemStyle: {
                            areaColor: '#ffcc00', // 【核心】地图变成金黄色
                            shadowColor: '#ffcc00', // 【核心】外发光颜色
                            shadowBlur: 30,         // 【核心】光晕大小
                            opacity: 1
                        }
                    },
                    emphasis: {
                        label: { show: false },
                        itemStyle: {
                            areaColor: '#ffcc00'
                        }
                    },
                    // 政治正确性映射与中文支持
                    nameMap: {
                        'China': '中国',
                        'Bulgaria': '保加利亚',
                        'United States': '美国',
                        'Russia': '俄罗斯',
                        // 强制修正，无论数据源如何，将 Taiwan 映射名为“中国台湾”
                        // 下面的逻辑会确保说“中国”时，它也亮
                        'Taiwan': '中国台湾' 
                    }
                },
                series: []
            };
            myChart.setOption(option);
        }

        // --- 核心步骤3：语音识别逻辑 ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').innerText = "错误：您的浏览器不支持 Web Speech API。请使用 Chrome 或 Edge 桌面版。";
                document.getElementById('start-btn').style.display = 'none';
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; // 采用自动重启策略，比 continuous=true 更稳定
            recognition.interimResults = false;

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                document.getElementById('main-status').innerText = `收到指令: "${text}"`;
                handleMapAction(text);
            };

            recognition.onend = function() {
                // 自动重启监听，实现“只点一次”
                // 注意：如果页面在后台，浏览器可能会暂停它，切回来会自动恢复
                try {
                    recognition.start();
                } catch(e) {
                    console.log("监听重启中...");
                }
            };
            
            recognition.onerror = function(event) {
                console.log("识别错误:", event.error);
                // 忽略特定错误，防止循环弹窗
                if (event.error === 'not-allowed') {
                     document.getElementById('main-status').innerText = "请允许麦克风权限";
                }
            };

            // 绑定按钮
            document.getElementById('start-btn').onclick = function() {
                try {
                    recognition.start();
                    this.style.display = 'none'; // 隐藏按钮
                    document.getElementById('main-status').innerText = "正在聆听... 请说：我来自中国";
                } catch(e) {
                    alert("无法启动麦克风，请检查浏览器权限设置");
                }
            };
        }

        // --- 核心步骤4：指令处理与发光逻辑 ---
        function handleMapAction(text) {
            // 1. 先熄灭所有灯光
            myChart.dispatchAction({ type: 'geoUnSelect' });

            // 2. 逻辑判断
            if (text.includes("中国")) {
                // 无论是大陆还是台湾，只要说中国，一起发光
                lightUpRegion("中国");
                lightUpRegion("中国台湾"); 
                document.getElementById('main-status').innerText = "欢迎来自 中国 的朋友！";
            } 
            else if (text.includes("保加利亚")) {
                lightUpRegion("保加利亚");
                document.getElementById('main-status').innerText = "欢迎来自 保加利亚 的朋友！";
            }
            // 你可以在这里加更多国家
            else {
                // 未匹配到
                setTimeout(() => {
                    document.getElementById('main-status').innerText = "正在聆听...";
                }, 2000);
            }
        }

        function lightUpRegion(name) {
            // 触发 ECharts 的 select 状态，调用我们在 option 里定义的金色发光样式
            myChart.dispatchAction({
                type: 'geoSelect',
                name: name
            });
        }
        
        // 窗口大小适配
        window.addEventListener('resize', () => myChart.resize());

    </script>
</body>
</html>
