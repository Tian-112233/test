<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声控中国地图 - 自动纠错版</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #021019;
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        #map-container {
            width: 100%;
            height: 100%;
        }

        /* 状态提示栏 */
        #status-bar {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none;
        }

        #voice-text {
            color: #00d0ff;
            background: rgba(0, 20, 40, 0.9);
            padding: 15px 40px;
            border-radius: 40px;
            border: 2px solid #00d0ff;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(0, 208, 255, 0.4);
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        #sub-text {
            color: #aaa;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 4px 10px;
            border-radius: 10px;
        }

        /* 控制按钮 */
        #start-btn {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 15px 50px;
            font-size: 20px;
            background: linear-gradient(90deg, #00d0ff, #0080ff);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 0 25px rgba(0, 128, 255, 0.6);
            outline: none;
        }

        #start-btn:active {
            transform: translateX(-50%) scale(0.95);
        }

        /* 录音中的呼吸灯效果 */
        .listening-mode {
            animation: breathe 2s infinite;
            border-color: #ff3333 !important;
            color: #ff3333 !important;
            box-shadow: 0 0 20px rgba(255, 50, 50, 0.4) !important;
        }

        @keyframes breathe {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.02); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>

    <div id="status-bar">
        <div id="voice-text">点击下方按钮开启声控</div>
        <div id="sub-text">支持 Edge 和 Chrome 浏览器</div>
    </div>
    
    <div id="map-container"></div>
    <button id="start-btn">开启麦克风权限</button>

    <script>
        // --- 1. 地图初始化部分 ---
        const myChart = echarts.init(document.getElementById('map-container'));
        
        // 显示加载动画
        myChart.showLoading({
            text: '正在加载地图数据...',
            color: '#00d0ff',
            textColor: '#fff',
            maskColor: 'rgba(2, 16, 25, 0.8)'
        });

        // 加载世界地图 JSON
        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(response => response.json())
            .then(worldJson => {
                myChart.hideLoading();
                echarts.registerMap('world', worldJson);

                const option = {
                    backgroundColor: '#021019',
                    // 悬浮提示
                    tooltip: {
                        trigger: 'item',
                        formatter: function(params) {
                            // 修正提示框显示，如果是中国台湾，显示为中国
                            if (params.name === '中国台湾') return '中国 (China)';
                            return params.name;
                        }
                    },
                    geo: {
                        map: 'world',
                        roam: true, // 允许缩放和平移
                        zoom: 1.2,
                        center: [115, 30], // 锁定中国视角
                        label: { show: false },
                        itemStyle: {
                            areaColor: '#323c48', // 默认颜色
                            borderColor: '#111',
                            borderWidth: 0.5
                        },
                        // 高亮/选中样式
                        select: {
                            label: { show: true, color: '#fff', fontSize: 16 },
                            itemStyle: {
                                areaColor: '#f4e925', // 发光的金色
                                shadowBlur: 30, // 光晕大小
                                shadowColor: 'rgba(255, 230, 0, 1)' // 光晕颜色
                            }
                        },
                        emphasis: {
                            disabled: false, // 允许鼠标悬停高亮
                            label: { show: true, color: '#fff' },
                            itemStyle: {
                                areaColor: '#f4e925'
                            }
                        },
                        // 关键：NameMap 映射
                        nameMap: {
                            'China': '中国',
                            'Bulgaria': '保加利亚',
                            'Taiwan': '中国台湾' // 将数据源中的 Taiwan 映射为内部名称
                        }
                    },
                    series: []
                };
                myChart.setOption(option);
            });

        // --- 2. 语音识别部分 ---
        
        // 兼容 Edge 和 Chrome 的写法
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;

        const statusText = document.getElementById('voice-text');
        const startBtn = document.getElementById('start-btn');

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; // 设为 false 提高单句识别准确率，我们用 onend 自动重启
            recognition.interimResults = false;

            // 当识别开始
            recognition.onstart = function() {
                isListening = true;
                statusText.innerText = "我在听... (请说：我来自中国)";
                statusText.classList.add('listening-mode');
                startBtn.style.display = 'none'; // 隐藏按钮，实现“只点一次”的感觉
            };

            // 当识别结束（无论是否成功）
            recognition.onend = function() {
                isListening = false;
                statusText.classList.remove('listening-mode');
                
                // 自动重启机制：只要页面没关，就重新开始听
                // 注意：如果是在本地文件 file:// 运行，这里可能会被浏览器拦截
                setTimeout(() => {
                    try {
                        recognition.start();
                    } catch(e) {
                        console.log("重启监听失败，等待用户点击");
                        startBtn.style.display = 'block';
                        startBtn.innerText = "连接断开，点击重试";
                    }
                }, 500); 
            };

            // 当识别到结果
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log("用户说了:", transcript);
                processCommand(transcript);
            };

            // 按钮点击启动
            startBtn.onclick = function() {
                try {
                    recognition.start();
                } catch(e) {
                    console.log("已启动");
                }
            };

        } else {
            statusText.innerText = "您的浏览器不支持语音功能";
            startBtn.style.display = 'none';
            alert("错误：请使用 Chrome 或 Edge 浏览器桌面版。");
        }

        // --- 3. 核心逻辑处理 (修复了欢迎语 Bug) ---
        
        function processCommand(text) {
            // 清除之前的高亮
            myChart.dispatchAction({ type: 'geoUnSelect' });

            // 逻辑 A: 用户说中国
            if (text.indexOf("中国") !== -1) {
                // 1. 视觉效果：同时点亮大陆和台湾
                highlightRegion('中国');
                highlightRegion('中国台湾'); // 即使数据源把台湾分开了，我们也点亮它
                
                // 2. 状态文字：强制显示为中国 (修复了之前显示台湾的问题)
                updateStatusText("欢迎来自 中国 的朋友！"); 
            }
            // 逻辑 B: 用户说保加利亚
            else if (text.indexOf("保加利亚") !== -1) {
                highlightRegion('保加利亚');
                updateStatusText("欢迎来自 保加利亚 的朋友！");
            }
            // 逻辑 C: 无法识别
            else {
                // 临时显示一下识别到的内容，然后让它迅速恢复监听状态
                statusText.innerText = `识别内容: "${text}" (无效指令)`;
            }
        }

        // 辅助函数：仅负责地图高亮，不负责改文字
        function highlightRegion(mapName) {
            myChart.dispatchAction({
                type: 'geoSelect',
                name: mapName
            });
        }

        // 辅助函数：更新界面文字
        function updateStatusText(msg) {
            statusText.innerText = msg;
            // 保持高亮状态的文字颜色
            statusText.style.borderColor = "#f4e925";
            statusText.style.color = "#f4e925";
            
            // 3秒后恢复默认颜色（可选）
            setTimeout(() => {
                statusText.style.borderColor = "#00d0ff";
                statusText.style.color = "#00d0ff";
            }, 3000);
        }

        // 窗口自适应
        window.onresize = function() {
            myChart.resize();
        };

    </script>
</body>
</html>
