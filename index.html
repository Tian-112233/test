
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°æ§æ——å¸œ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .flag-container {
            position: relative;
            width: 80vw;
            max-width: 600px;
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            border: 2px solid #444;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background: #111;
        }

        .flag {
            position: absolute;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            filter: grayscale(100%); 
            transition: filter 0.1s linear, opacity 0.5s ease;
            opacity: 0;
        }

        .flag.active {
            opacity: 1;
            z-index: 2;
        }

        /* çŠ¶æ€æ˜¾ç¤ºåŒº */
        .status-container {
            text-align: center;
            margin-bottom: 20px;
            z-index: 10;
            height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .country-name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #888;
            margin-bottom: 5px;
        }

        .progress-text {
            font-size: 3rem;
            color: #fff;
            font-family: monospace; 
            font-weight: bold;
            transition: color 0.3s;
        }

        /* 100% æ—¶çš„ç‰¹æ•ˆ - æ›´åŠ æ˜¾çœ¼ */
        .full-power {
            color: #ff3333 !important; /* æ»¡èƒ½é‡å˜æˆçº¢è‰² */
            text-shadow: 0 0 20px #ff0000;
            animation: shake 0.5s infinite;
        }
        
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .subtitle-box {
            font-size: 1.1rem;
            color: #0f0;
            background: rgba(0,0,0,0.6);
            padding: 5px 20px;
            border-radius: 4px;
            min-height: 28px;
            border: 1px solid #444;
            max-width: 80%;
            text-align: center;
            margin-top: 10px;
            opacity: 0.9;
        }

        #visualizer {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 120px;
            z-index: 1; opacity: 0.3; pointer-events: none;
        }

        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100;
        }
        button { padding: 15px 40px; font-size: 1.5rem; cursor: pointer; border-radius: 50px; border:none; background: #fff; color:#000; font-weight:bold;}
        button:hover { background: #eee; transform: scale(1.05); }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>å£°æ§æ——å¸œ</h1>
        <p style="color:#aaa;">è¯·ä½¿ç”¨ Chrome/Edge æµè§ˆå™¨</p>
        <p style="color:#888; font-size:0.9rem">æç¤ºï¼šå¦‚æœä¸æŒç»­å¤§å£°å‘¼å”¤ï¼Œé¢œè‰²ä¼šå¾ˆå¿«æ¶ˆå¤±</p>
        <button id="startBtn">å¼€å§‹æŒ‘æˆ˜</button>
    </div>

    <div class="flag-container">
        <div id="china" class="flag active" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/f/fa/Flag_of_the_People%27s_Republic_of_China.svg');"></div>
        <div id="bulgaria" class="flag" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/9/9a/Flag_of_Bulgaria.svg');"></div>
    </div>

    <div class="status-container">
        <div class="country-name" id="countryName">å½“å‰ï¼šä¸­å›½</div>
        <div class="progress-text" id="progressText">0%</div>
    </div>

    <div class="subtitle-box" id="subtitle">è¯·æŒç»­å‘¼å–Šï¼šä¸­å›½ / ä¿åŠ åˆ©äºš</div>

    <canvas id="visualizer"></canvas>

<script>
    // --- ã€å…³é”®ä¿®æ”¹ã€‘éš¾åº¦å‚æ•°è°ƒæ•´ ---
    
    // 1. è¡°å‡é€Ÿåº¦ï¼šä» 0.08 æå‡åˆ° 0.15 (ä¸è¯´è¯æ—¶æ‰å¾—æ›´å¿«)
    const DECAY_RATE = 0.15;         
    
    const MAX_SHOWN_SCORE = 100;
    // 2. ç¼“å†²åŒºå‡å°‘ï¼šä» 130 é™åˆ° 110 (å³ä½¿å……æ»¡äº†ï¼Œåªè¦ç¨åœä¸€ä¸‹é©¬ä¸Šå°±ä¼šè·Œç ´100)
    const MAX_INTERNAL_SCORE = 110;  
    
    // 3. å¢é‡å‰Šå¼±
    // åŸºç¡€åˆ†ä» 15 é™åˆ° 8 (å°å£°è¯´è¯å‡ ä¹æ²¡ç”¨)
    const BASE_BOOST = 8;           
    // éŸ³é‡ç³»æ•°ä» 60 é™åˆ° 35 (åªæœ‰å¤§å£°å–Šæ‰èƒ½æ¶¨å¾—åŠ¨)
    const VOLUME_BOOST_FACTOR = 35;  
    
    
    // --- å˜é‡ ---
    let currentFlag = 'china';
    let saturation = 0;
    let audioContext, analyser, dataArray;
    let recognition;
    let isRunning = false;
    let currentVolume = 0; 
    let lastTriggerTime = 0;

    // --- DOM ---
    const flagChina = document.getElementById('china');
    const flagBulgaria = document.getElementById('bulgaria');
    const countryNameEl = document.getElementById('countryName');
    const progressTextEl = document.getElementById('progressText');
    const subtitleText = document.getElementById('subtitle');
    const startBtn = document.getElementById('startBtn');
    const overlay = document.getElementById('overlay');
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');

    startBtn.addEventListener('click', () => {
        initAudio();
        initSpeech();
        overlay.style.display = 'none';
        isRunning = true;
        renderLoop();
    });

    async function initAudio() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 256;
            analyser.smoothingTimeConstant = 0.6; // è®©æ³¢å½¢ä¸é‚£ä¹ˆæŠ–åŠ¨ï¼Œçœ‹èµ·æ¥æ›´ç¨³
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        } catch (e) {
            alert("æ— æ³•å¯åŠ¨éº¦å…‹é£: " + e);
        }
    }

    function initSpeech() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            subtitleText.innerText = "âŒ æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«";
            return;
        }

        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'zh-CN';

        recognition.onstart = () => { subtitleText.innerText = "ç›‘å¬ä¸­..."; };
        recognition.onend = () => { if (isRunning) recognition.start(); };

        recognition.onresult = (event) => {
            let transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                transcript += event.results[i][0].transcript;
            }
            subtitleText.innerText = "ğŸ‘‚: " + transcript.slice(-10);

            if (transcript.includes('ä¿åŠ åˆ©äºš')) {
                triggerAction('bulgaria');
            } else if (transcript.includes('ä¸­å›½')) {
                triggerAction('china');
            }
        };
        recognition.start();
    }

    function triggerAction(country) {
        const now = Date.now();
        if (now - lastTriggerTime < 400) return; 
        lastTriggerTime = now;

        if (currentFlag !== country) {
            switchFlag(country);
            saturation = 10; // åˆ‡æ¢å›½å®¶åªç»™ 10% çš„èµ·æ­¥åˆ†
        } else {
            // è®¡ç®—åŠ åˆ†
            let volumeBonus = (currentVolume / 255) * VOLUME_BOOST_FACTOR;
            let totalBoost = BASE_BOOST + volumeBonus;
            
            // æ²¡æœ‰ä¿åº•æœºåˆ¶äº†ï¼Œå£°éŸ³å°å°±æ˜¯åŠ å¾—å°‘
            saturation += totalBoost;
            
            // å­—å¹•åé¦ˆ
            subtitleText.style.color = '#fff';
            subtitleText.style.borderColor = '#fff';
            setTimeout(() => {
                subtitleText.style.color = '#0f0';
                subtitleText.style.borderColor = '#444';
            }, 300);
        }
    }

    function switchFlag(country) {
        currentFlag = country;
        saturation = 0; 
        
        if (country === 'china') {
            flagChina.classList.add('active');
            flagBulgaria.classList.remove('active');
            countryNameEl.innerText = "å½“å‰ï¼šä¸­å›½";
        } else {
            flagChina.classList.remove('active');
            flagBulgaria.classList.add('active');
            countryNameEl.innerText = "å½“å‰ï¼šä¿åŠ åˆ©äºš";
        }
    }

    function renderLoop() {
        requestAnimationFrame(renderLoop);
        
        if (analyser) {
            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) sum += dataArray[i];
            currentVolume = sum / dataArray.length;
        }

        saturation -= DECAY_RATE;
        
        if (saturation > MAX_INTERNAL_SCORE) saturation = MAX_INTERNAL_SCORE;
        if (saturation < 0) saturation = 0;

        let displaySaturation = Math.min(saturation, MAX_SHOWN_SCORE);
        
        updateUI(displaySaturation);
        drawVisualizer();
    }

    function updateUI(val) {
        const currentElement = currentFlag === 'china' ? flagChina : flagBulgaria;
        currentElement.style.filter = `grayscale(${100 - val}%)`;

        let intVal = Math.floor(val);
        progressTextEl.innerText = `${intVal}%`;

        // 100% æ—¶åŠ äº†çº¢è‰²éœ‡åŠ¨ç‰¹æ•ˆï¼Œå¢åŠ ç´§å¼ æ„Ÿ
        if (intVal >= 100) {
            progressTextEl.classList.add('full-power');
            progressTextEl.innerText = "âš¡ 100% âš¡";
        } else {
            progressTextEl.classList.remove('full-power');
        }
    }

    function drawVisualizer() {
        if (!dataArray) return;
        const w = canvas.width;
        const h = canvas.height;
        ctx.clearRect(0, 0, w, h);
        ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
        const barW = (w / dataArray.length) * 2.5;
        let x = 0;
        for (let i = 0; i < dataArray.length; i++) {
            let barH = dataArray[i] / 2.5;
            ctx.fillRect(x, h - barH, barW, barH);
            x += barW + 1;
        }
    }
    
    canvas.width = window.innerWidth;
    canvas.height = 120;

</script>
</body>
</html>
