<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>声控中国视角世界地图</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #021019; /* 深海蓝背景 */
            overflow: hidden;
            font-family: 'Microsoft YaHei', sans-serif;
        }

        #main {
            width: 100%;
            height: 100%;
        }

        /* 语音状态指示器 */
        #voice-status {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            color: #00d0ff;
            background: rgba(0, 20, 40, 0.8);
            padding: 10px 30px;
            border-radius: 30px;
            border: 1px solid #00d0ff;
            font-size: 18px;
            pointer-events: none; /* 让鼠标事件穿透 */
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(0, 208, 255, 0.3);
        }

        /* 控制按钮 */
        #control-btn {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            padding: 12px 40px;
            font-size: 18px;
            background: linear-gradient(90deg, #00d0ff, #0080ff);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 128, 255, 0.5);
        }
        
        #control-btn:hover {
            opacity: 0.9;
            transform: translateX(-50%) scale(1.05);
        }

        /* 录音时的动画效果 */
        .listening {
            animation: pulse 1.5s infinite;
            background: rgba(255, 50, 50, 0.2) !important;
            border-color: #ff3333 !important;
            color: #ff3333 !important;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 50, 50, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 50, 50, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 50, 50, 0); }
        }
    </style>
</head>
<body>

    <div id="voice-status">等待指令...</div>
    <div id="main"></div>
    <button id="control-btn">点击开始说话</button>

    <script>
        // 1. 初始化 ECharts 实例
        var myChart = echarts.init(document.getElementById('main'));
        var recognition; // 语音识别对象

        // 显示加载动画
        myChart.showLoading();

        // 2. 获取地图数据
        // 注意：为了演示，这里使用了公共 CDN 的 World JSON。
        // 在正式生产环境中，为了绝对严谨的政治合规（如九段线），建议下载阿里云 DataV 的 world.json 本地引用
        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(response => response.json())
            .then(worldJson => {
                myChart.hideLoading();
                
                // 注册地图
                echarts.registerMap('world', worldJson);

                // 3. 配置项
                var option = {
                    backgroundColor: '#021019',
                    title: {
                        text: '声控世界地图 (中国 & 保加利亚)',
                        left: 'center',
                        top: 20,
                        textStyle: { color: '#fff' }
                    },
                    // 提示框
                    tooltip: {
                        trigger: 'item',
                        formatter: '{b}'
                    },
                    geo: {
                        map: 'world',
                        roam: true, // 开启缩放和平移
                        zoom: 1.2,
                        // 核心：设置中心点，调整为中国/太平洋视角 (经度 115)
                        center: [115, 30], 
                        label: {
                            show: false
                        },
                        // 地图区域的多边形 图形样式
                        itemStyle: {
                            areaColor: '#323c48', // 普通状态颜色
                            borderColor: '#111'
                        },
                        // 选中/高亮时的样式（发光效果）
                        select: {
                            itemStyle: {
                                areaColor: '#f4e925', // 选中后的金色
                                shadowBlur: 20,
                                shadowColor: 'rgba(255, 215, 0, 0.8)'
                            },
                            label: { show: true, color: '#000' }
                        },
                        emphasis: {
                            itemStyle: {
                                areaColor: '#f4e925',
                                shadowBlur: 20,
                                shadowColor: 'rgba(255, 215, 0, 0.8)'
                            },
                            label: { show: true, color: '#000' }
                        },
                        // 关键：名称映射，确保数据匹配，并修正可能的地图错误
                        nameMap: {
                            'China': '中国',
                            'Bulgaria': '保加利亚',
                            // 政治正确性修正：如果原 JSON 把台湾单独列出，这里尝试将其归并（视 JSON 结构而定）
                            // 即使 JSON 把 Taiwan 视为独立块，我们也将其显示名称改为中国，
                            // 并在逻辑中处理高亮
                            'Taiwan': '中国台湾' 
                        }
                    },
                    series: [] 
                };

                myChart.setOption(option);
                
                // 绑定点击事件用于测试（非语音）
                myChart.on('click', function (params) {
                    console.log("点击了: " + params.name);
                });
            });

        // 4. 语音识别逻辑 (Web Speech API)
        function initSpeech() {
            // 兼容性处理
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                alert("您的浏览器不支持语音识别，请使用最新版 Chrome 或 Edge 浏览器。");
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN'; // 识别中文
            recognition.continuous = false; // 每次只识别一句
            recognition.interimResults = false;

            const statusDiv = document.getElementById('voice-status');
            const btn = document.getElementById('control-btn');

            recognition.onstart = function() {
                statusDiv.innerText = "正在聆听...";
                statusDiv.classList.add('listening');
                btn.innerText = "聆听中...";
            };

            recognition.onend = function() {
                statusDiv.classList.remove('listening');
                btn.innerText = "点击开始说话";
                // 如果你想让它一直听，可以在这里调用 recognition.start()
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                statusDiv.innerText = `识别到: "${transcript}"`;
                console.log("语音内容:", transcript);
                
                // 处理指令
                handleCommand(transcript);
            };

            // 绑定按钮点击
            btn.onclick = function() {
                try {
                    recognition.start();
                } catch (e) {
                    // 防止重复启动报错
                    console.log("已启动");
                }
            };
        }

        // 5. 核心：处理语音指令并点亮地图
        function handleCommand(text) {
            // 清除之前的选中状态
            myChart.dispatchAction({ type: 'geoUnSelect' });

            // 逻辑判断
            // 匹配 "我来自中国" 或 "中国" 等关键词
            if (text.indexOf("中国") !== -1) {
                highlightMap("中国");
                // 额外逻辑：如果地图数据将台湾分离，手动点亮台湾区域（名字需匹配 nameMap）
                // 尝试点亮常见的台湾命名变体，确保版图完整
                highlightMap("中国台湾"); 
            } 
            else if (text.indexOf("保加利亚") !== -1) {
                highlightMap("保加利亚");
            } 
            else {
                document.getElementById('voice-status').innerText = `无法识别国家: "${text}"`;
            }
        }

        // 封装高亮函数
        function highlightMap(countryName) {
            // ECharts 触发选中
            myChart.dispatchAction({
                type: 'geoSelect',
                name: countryName
            });
            // 触发高亮（鼠标悬浮效果）
            myChart.dispatchAction({
                type: 'highlight',
                name: countryName
            });
            
            document.getElementById('voice-status').innerText = `欢迎来自 ${countryName} 的朋友！`;
        }

        // 启动语音功能
        initSpeech();

        // 窗口大小改变时重绘地图
        window.addEventListener('resize', function() {
            myChart.resize();
        });

    </script>
</body>
</html>
