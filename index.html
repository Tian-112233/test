<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°æ§ä¸­å›½ç‰ˆä¸–ç•Œåœ°å›¾ (æœ€ç»ˆä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #0b1124; /* æ·±è“èƒŒæ™¯ */
            overflow: hidden;
            font-family: "Microsoft YaHei", sans-serif;
        }

        #map-container {
            width: 100%;
            height: 100%;
        }

        /* çŠ¶æ€æ˜¾ç¤ºæ  */
        #status-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            text-align: center;
            pointer-events: none;
        }

        #voice-msg {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00d0ff;
            color: #00d0ff;
            padding: 10px 30px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(0, 208, 255, 0.3);
            transition: all 0.3s;
        }

        /* æŒ‰é’®æ ·å¼ */
        #start-btn {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 200;
            padding: 15px 50px;
            background: linear-gradient(135deg, #0066ff, #00ccff);
            color: white;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 150, 255, 0.5);
            transition: transform 0.1s;
        }

        #start-btn:active { transform: translateX(-50%) scale(0.95); }

    </style>
</head>
<body>

    <div id="status-bar">
        <div id="voice-msg">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’® -> å…è®¸éº¦å…‹é£ -> è¯´è¯</div>
    </div>
    
    <div id="map-container"></div>
    <button id="start-btn">ç‚¹å‡»å¼€å¯å£°æ§</button>

    <script>
        const myChart = echarts.init(document.getElementById('map-container'));
        let recognition;

        // 1. åŠ è½½å¹¶é‡æ„åœ°å›¾æ•°æ® (å¤ªå¹³æ´‹è§†è§’)
        myChart.showLoading({ text: 'æ­£åœ¨æ„å»ºä¸­å›½ç‰ˆä¸–ç•Œåœ°å›¾...', color: '#00d0ff', textColor: '#fff' });

        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json())
            .then(worldJson => {
                
                // === åœ°å›¾ç§»ä½ç®—æ³•ï¼šå°†è¥¿ç»åŒºåŸŸæ¬è¿åˆ°ä¸œè¾¹ï¼Œå½¢æˆä¸­å›½è§†è§’ ===
                worldJson.features.forEach(feature => {
                    const geometry = feature.geometry;
                    const shiftCoord = (coord) => {
                        // å¦‚æœç»åº¦å°äº -30 (å¤§è¥¿æ´‹)ï¼ŒåŠ  360 åº¦ï¼Œç§»åˆ°æœ€å³è¾¹
                        if (coord[0] < -30) coord[0] += 360;
                        return coord;
                    };
                    // éå†æ‰€æœ‰åæ ‡ç‚¹è¿›è¡Œä¿®æ”¹
                    if (geometry.type === "Polygon") {
                        geometry.coordinates.forEach(ring => ring.forEach(shiftCoord));
                    } else if (geometry.type === "MultiPolygon") {
                        geometry.coordinates.forEach(poly => poly.forEach(ring => ring.forEach(shiftCoord)));
                    }
                });
                // ========================================================

                echarts.registerMap('world', worldJson);
                myChart.hideLoading();
                initMap();
                initSpeech();
            });

        // 2. åˆå§‹åŒ–åœ°å›¾é…ç½®
        function initMap() {
            const option = {
                backgroundColor: '#0b1124',
                // æç¤ºæ¡†
                tooltip: {
                    trigger: 'item',
                    formatter: '{b}' 
                },
                series: [
                    {
                        type: 'map',
                        map: 'world',
                        roam: true,
                        zoom: 1.1,
                        center: [150, 30], // è°ƒæ•´ä¸­å¿ƒç‚¹åˆ°å¤ªå¹³æ´‹
                        
                        // --- å…³é”®ä¿®æ”¹ï¼šé»˜è®¤æ˜¾ç¤ºåå­— ---
                        label: {
                            show: true,           // æ˜¾ç¤ºåå­—
                            color: '#999',        // é»˜è®¤åå­—é¢œè‰²
                            fontSize: 10
                        },

                        // --- å…³é”®ä¿®æ”¹ï¼šæ™®é€šçŠ¶æ€æ ·å¼ ---
                        itemStyle: {
                            areaColor: '#1a2640', // æ·±è“æ¿å—
                            borderColor: '#455a84',
                            borderWidth: 1
                        },

                        // --- å…³é”®ä¿®æ”¹ï¼šé€‰ä¸­/å‘å…‰æ ·å¼ (æœ€å¼ºé«˜äº®) ---
                        selectedMode: 'multiple', // å…è®¸é€‰ä¸­å¤šä¸ª
                        select: {
                            label: { 
                                show: true, 
                                color: '#000',     // é€‰ä¸­åæ–‡å­—å˜é»‘
                                fontWeight: 'bold',
                                fontSize: 16       // é€‰ä¸­åå­—å˜å¤§
                            },
                            itemStyle: {
                                areaColor: '#ffcc00', // äº®é‡‘é»„è‰²
                                borderColor: '#fff',
                                borderWidth: 2,
                                shadowColor: 'rgba(255, 204, 0, 1)', // å¼ºçƒˆçš„é‡‘è‰²å…‰æ™•
                                shadowBlur: 30
                            }
                        },

                        // --- å¿…é¡»é…ç½®ï¼šä¸­æ–‡åç§°æ˜ å°„ ---
                        // åªæœ‰åœ¨è¿™é‡Œé…ç½®äº†ï¼Œä½ ä¸‹é¢çš„ä»£ç æ‰èƒ½é€šè¿‡ "ä¸­å›½" æ‰¾åˆ°åœ°å›¾æ¿å—
                        nameMap: {
                            'China': 'ä¸­å›½',
                            'Bulgaria': 'ä¿åŠ åˆ©äºš',
                            'United States': 'ç¾å›½',
                            'Russia': 'ä¿„ç½—æ–¯',
                            'Japan': 'æ—¥æœ¬',
                            'Australia': 'æ¾³å¤§åˆ©äºš',
                            'Canada': 'åŠ æ‹¿å¤§',
                            'United Kingdom': 'è‹±å›½',
                            'France': 'æ³•å›½',
                            'Germany': 'å¾·å›½',
                            'India': 'å°åº¦',
                            'Brazil': 'å·´è¥¿',
                            'Taiwan': 'ä¸­å›½å°æ¹¾' // å¼ºåˆ¶æ˜ å°„
                        },
                        data: [] // æ•°æ®æš‚ç©ºï¼Œé€šè¿‡äº‹ä»¶è§¦å‘
                    }
                ]
            };
            myChart.setOption(option);
        }

        // 3. è¯­éŸ³è¯†åˆ«é€»è¾‘
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                document.getElementById('voice-msg').innerText = "é”™è¯¯ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ (è¯·ç”¨ Chrome/Edge)";
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; 
            recognition.interimResults = false;

            const msgBox = document.getElementById('voice-msg');
            const btn = document.getElementById('start-btn');

            recognition.onstart = function() {
                msgBox.innerText = "ğŸ¤ æ­£åœ¨è†å¬... è¯·è¯´ï¼šæˆ‘æ¥è‡ªä¸­å›½";
                msgBox.style.color = "#fff";
                msgBox.style.borderColor = "#fff";
                btn.style.display = 'none'; // éšè—æŒ‰é’®
            };

            recognition.onend = function() {
                // è‡ªåŠ¨é‡å¯ç›‘å¬
                try { recognition.start(); } catch(e) {}
            };

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                console.log("è¯†åˆ«ç»“æœ:", text);
                
                // å¤„ç†æŒ‡ä»¤
                handleCommand(text);
            };

            // æŒ‰é’®ç‚¹å‡»
            btn.onclick = function() {
                try {
                    recognition.start();
                } catch(e) {
                    console.log("å·²å¯åŠ¨");
                }
            };
        }

        // 4. å¤„ç†å‘å…‰æŒ‡ä»¤
        function handleCommand(text) {
            const msgBox = document.getElementById('voice-msg');
            
            // å…ˆæ¸…ç©ºæ‰€æœ‰é«˜äº®
            myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 }); // æ¸…é™¤ select çŠ¶æ€
            myChart.dispatchAction({ type: 'downplay', seriesIndex: 0 }); // æ¸…é™¤ emphasis çŠ¶æ€

            // é€»è¾‘åˆ¤æ–­
            if (text.includes("ä¸­å›½")) {
                highlightCountry("ä¸­å›½");
                highlightCountry("ä¸­å›½å°æ¹¾"); // ç¡®ä¿å°æ¹¾ä¸€èµ·äº®
                msgBox.innerText = "ğŸ‘‹ æ¬¢è¿æ¥è‡ª ä¸­å›½ çš„æœ‹å‹ï¼";
                msgBox.style.color = "#ffcc00"; // æ–‡å­—å˜é‡‘
                msgBox.style.borderColor = "#ffcc00";
            } 
            else if (text.includes("ä¿åŠ åˆ©äºš")) {
                highlightCountry("ä¿åŠ åˆ©äºš");
                msgBox.innerText = "ğŸ‘‹ æ¬¢è¿æ¥è‡ª ä¿åŠ åˆ©äºš çš„æœ‹å‹ï¼";
                msgBox.style.color = "#ffcc00";
                msgBox.style.borderColor = "#ffcc00";
            }
            else {
                msgBox.innerText = `ğŸ¤” å¬åˆ°äº†: "${text}" (æœªåŒ¹é…å›½å®¶)`;
                msgBox.style.color = "#00d0ff";
                msgBox.style.borderColor = "#00d0ff";
            }
        }

        // 5. æ‰§è¡Œé«˜äº®åŠ¨ä½œ
        function highlightCountry(name) {
            // ECharts è§¦å‘é€‰ä¸­çš„æ ¸å¿ƒä»£ç 
            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨çš„æ˜¯ 'select' åŠ¨ä½œï¼Œé…åˆä¸Šé¢çš„ selectedMode: 'multiple'
            myChart.dispatchAction({
                type: 'select',
                seriesIndex: 0,
                name: name
            });
            
            // ä¸ºäº†ä¿é™©ï¼ŒåŒæ—¶è§¦å‘é«˜äº® emphasis
            myChart.dispatchAction({
                type: 'highlight',
                seriesIndex: 0,
                name: name
            });
        }

        // çª—å£è‡ªé€‚åº”
        window.onresize = function() { myChart.resize(); };

    </script>
</body>
</html>
