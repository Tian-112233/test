<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨èƒ½å£°æ§ä¸–ç•Œåœ°å›¾ (ä¸­å›½è§†è§’)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: #0b1124; overflow: hidden; font-family: "Microsoft YaHei", sans-serif; }
        #map-container { width: 100%; height: 100%; }
        
        /* é¡¶éƒ¨çŠ¶æ€æ¡ */
        #status-bar { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; text-align: center; width: 80%; }
        #voice-msg { display: inline-block; background: rgba(0, 0, 0, 0.7); border: 1px solid #00d0ff; color: #00d0ff; padding: 12px 40px; border-radius: 50px; font-size: 22px; font-weight: bold; box-shadow: 0 0 20px rgba(0, 208, 255, 0.2); transition: all 0.3s; }
        
        /* å¼€å§‹æŒ‰é’® */
        #start-btn { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); z-index: 200; padding: 15px 50px; background: linear-gradient(135deg, #0066ff, #00ccff); color: white; border: none; border-radius: 30px; font-size: 18px; cursor: pointer; box-shadow: 0 5px 20px rgba(0, 150, 255, 0.5); transition: transform 0.1s; }
        #start-btn:active { transform: translateX(-50%) scale(0.95); }
    </style>
</head>
<body>

    <div id="status-bar"><div id="voice-msg">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’® -> å…è®¸æƒé™ -> ç•…æ‰€æ¬²è¨€</div></div>
    <div id="map-container"></div>
    <button id="start-btn">å¼€å¯å…¨èƒ½å£°æ§</button>

    <script>
        const myChart = echarts.init(document.getElementById('map-container'));
        let recognition;
        let lightTimer = null; // ç”¨äºæ§åˆ¶2ç§’ç†„ç­çš„è®¡æ—¶å™¨

        // --- 1. æ ¸å¿ƒï¼šä¸–ç•Œå„å›½åç§°æ˜ å°„è¡¨ (è‹±æ–‡ -> ä¸­æ–‡) ---
        // è¿™æ˜¯è®©â€œæ‰€æœ‰å›½å®¶éƒ½èƒ½è¯†åˆ«â€çš„å…³é”®ã€‚EChartsç”¨è‹±æ–‡Keyï¼Œæˆ‘ä»¬æ˜¾ç¤ºä¸­æ–‡Valueã€‚
        const countryNameMap = {
            'China': 'ä¸­å›½', 'Taiwan': 'ä¸­å›½å°æ¹¾',
            'United States': 'ç¾å›½', 'Russia': 'ä¿„ç½—æ–¯', 'Japan': 'æ—¥æœ¬',
            'United Kingdom': 'è‹±å›½', 'France': 'æ³•å›½', 'Germany': 'å¾·å›½',
            'Canada': 'åŠ æ‹¿å¤§', 'Australia': 'æ¾³å¤§åˆ©äºš', 'India': 'å°åº¦',
            'Brazil': 'å·´è¥¿', 'Argentina': 'é˜¿æ ¹å»·', 'South Africa': 'å—é',
            'South Korea': 'éŸ©å›½', 'North Korea': 'æœé²œ', 'Italy': 'æ„å¤§åˆ©',
            'Spain': 'è¥¿ç­ç‰™', 'Portugal': 'è‘¡è„ç‰™', 'Netherlands': 'è·å…°',
            'Belgium': 'æ¯”åˆ©æ—¶', 'Switzerland': 'ç‘å£«', 'Sweden': 'ç‘å…¸',
            'Norway': 'æŒªå¨', 'Finland': 'èŠ¬å…°', 'Denmark': 'ä¸¹éº¦',
            'Ukraine': 'ä¹Œå…‹å…°', 'Poland': 'æ³¢å…°', 'Turkey': 'åœŸè€³å…¶',
            'Iran': 'ä¼Šæœ—', 'Iraq': 'ä¼Šæ‹‰å…‹', 'Saudi Arabia': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯',
            'Egypt': 'åŸƒåŠ', 'Pakistan': 'å·´åŸºæ–¯å¦', 'Indonesia': 'å°åº¦å°¼è¥¿äºš',
            'Vietnam': 'è¶Šå—', 'Thailand': 'æ³°å›½', 'Malaysia': 'é©¬æ¥è¥¿äºš',
            'Philippines': 'è²å¾‹å®¾', 'Singapore': 'æ–°åŠ å¡', 'Mexico': 'å¢¨è¥¿å“¥',
            'Bulgaria': 'ä¿åŠ åˆ©äºš', 'Greece': 'å¸Œè…Š', 'Iceland': 'å†°å²›',
            'Mongolia': 'è’™å¤', 'Kazakhstan': 'å“ˆè¨å…‹æ–¯å¦', 'New Zealand': 'æ–°è¥¿å…°',
            'Chile': 'æ™ºåˆ©', 'Peru': 'ç§˜é²', 'Colombia': 'å“¥ä¼¦æ¯”äºš',
            'Ireland': 'çˆ±å°”å…°', 'Austria': 'å¥¥åœ°åˆ©', 'Hungary': 'åŒˆç‰™åˆ©',
            'Romania': 'ç½—é©¬å°¼äºš', 'Czech Republic': 'æ·å…‹', 'Slovakia': 'æ–¯æ´›ä¼å…‹',
            'Israel': 'ä»¥è‰²åˆ—', 'Syria': 'å™åˆ©äºš', 'Afghanistan': 'é˜¿å¯Œæ±—',
            'Myanmar': 'ç¼…ç”¸', 'Cambodia': 'æŸ¬åŸ”å¯¨', 'Laos': 'è€æŒ',
            'Cuba': 'å¤å·´', 'Venezuela': 'å§”å†…ç‘æ‹‰', 'Nigeria': 'å°¼æ—¥åˆ©äºš',
            'Kenya': 'è‚¯å°¼äºš', 'Ethiopia': 'åŸƒå¡ä¿„æ¯”äºš', 'Morocco': 'æ‘©æ´›å“¥'
            // å¦‚æœè¿˜æœ‰ç¼ºçš„å›½å®¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œç»§ç»­æŒ‰ 'EnglishName': 'ä¸­æ–‡å' æ·»åŠ 
        };

        // --- 2. åŠ è½½ä¸é‡æ„åœ°å›¾ (ä¿æŒä¸­å›½è§†è§’) ---
        myChart.showLoading({ text: 'æ­£åœ¨åŠ è½½å…¨çƒæ•°æ®...', color: '#00d0ff', textColor: '#fff' });

        fetch('https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/json/world.json')
            .then(res => res.json())
            .then(worldJson => {
                // ç§»ä½ç®—æ³•ï¼šç¾æ´²ç§»åˆ°å³ä¾§
                worldJson.features.forEach(feature => {
                    const geometry = feature.geometry;
                    const shiftCoord = (coord) => {
                        if (coord[0] < -30) coord[0] += 360;
                        return coord;
                    };
                    if (geometry.type === "Polygon") {
                        geometry.coordinates.forEach(ring => ring.forEach(shiftCoord));
                    } else if (geometry.type === "MultiPolygon") {
                        geometry.coordinates.forEach(poly => poly.forEach(ring => ring.forEach(shiftCoord)));
                    }
                });

                echarts.registerMap('world', worldJson);
                myChart.hideLoading();
                initMap();
                initSpeech();
            });

        // --- 3. ECharts é…ç½® (æ»¡è¶³åå­—éšè—/æ˜¾ç¤ºéœ€æ±‚) ---
        function initMap() {
            const option = {
                backgroundColor: '#0b1124',
                tooltip: { trigger: 'item', formatter: '{b}' }, // é¼ æ ‡æ‚¬æµ®æç¤º
                series: [{
                    type: 'map',
                    map: 'world',
                    roam: true,
                    zoom: 1.1,
                    center: [150, 30], // å¤ªå¹³æ´‹ä¸­å¿ƒ
                    
                    // ã€å…³é”®ç‚¹1ã€‘å¹³æ—¶éšè—åå­—
                    label: { show: false }, 

                    // ã€å…³é”®ç‚¹2ã€‘æ™®é€šæ ·å¼
                    itemStyle: {
                        areaColor: '#1a2640', 
                        borderColor: '#455a84',
                        borderWidth: 1
                    },

                    // ã€å…³é”®ç‚¹3ã€‘é€‰ä¸­ï¼ˆå‘å…‰ï¼‰æ—¶çš„æ ·å¼
                    selectedMode: 'multiple',
                    select: {
                        // é€‰ä¸­æ—¶æ‰æ˜¾ç¤ºæ ‡ç­¾ï¼Œä¸”ä¸ºä¸­æ–‡(ç”±nameMapè‡ªåŠ¨å¤„ç†)
                        label: { show: true, color: '#000', fontWeight: 'bold', fontSize: 16 },
                        itemStyle: {
                            areaColor: '#ffcc00', // é‡‘è‰²
                            borderColor: '#fff',
                            borderWidth: 2,
                            shadowColor: 'rgba(255, 204, 0, 1)', // å¼ºå…‰
                            shadowBlur: 30
                        }
                    },
                    
                    // ã€å…³é”®ç‚¹4ã€‘é¼ æ ‡æ‚¬åœæ—¶ä¹Ÿæ˜¾ç¤ºåå­—
                    emphasis: {
                        label: { show: true, color: '#fff' },
                        itemStyle: { areaColor: '#ffcc00' }
                    },

                    // ã€å…³é”®ç‚¹5ã€‘æ³¨å…¥æ˜ å°„è¡¨
                    nameMap: countryNameMap
                }]
            };
            myChart.setOption(option);
        }

        // --- 4. è¯­éŸ³ä¸é€»è¾‘å¤„ç† ---
        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                document.getElementById('voice-msg').innerText = "æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³ (è¯·ç”¨ Chrome/Edge)";
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = false; 
            recognition.interimResults = false;

            const msgBox = document.getElementById('voice-msg');
            const btn = document.getElementById('start-btn');

            recognition.onstart = function() {
                msgBox.innerText = "ğŸ¤ æ­£åœ¨è†å¬...";
                msgBox.style.color = "#fff";
                msgBox.style.borderColor = "#fff";
                btn.style.display = 'none';
            };

            recognition.onend = function() {
                try { recognition.start(); } catch(e) {} // è‡ªåŠ¨ç»­å‘½
            };

            recognition.onresult = function(event) {
                const text = event.results[0][0].transcript;
                console.log("å¬åˆ°:", text);
                matchAndHighlight(text);
            };

            btn.onclick = function() {
                try { recognition.start(); } catch(e) { console.log("Started"); }
            };
        }

        // --- 5. æ ¸å¿ƒé€»è¾‘ï¼šå…¨é‡åŒ¹é… + 2ç§’è‡ªåŠ¨ç†„ç­ ---
        function matchAndHighlight(text) {
            const msgBox = document.getElementById('voice-msg');
            let found = false;
            let matchedNameCN = "";

            // 1. æ¸…é™¤ä¸Šä¸€æ¬¡çš„å®šæ—¶å™¨ï¼Œé˜²æ­¢å†²çª
            if (lightTimer) {
                clearTimeout(lightTimer);
                lightTimer = null;
            }

            // 2. æ¸…é™¤å½“å‰çš„é«˜äº®
            myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 });
            myChart.dispatchAction({ type: 'downplay', seriesIndex: 0 });

            // 3. éå†å­—å…¸è¿›è¡Œæ¨¡ç³ŠåŒ¹é…
            // é€»è¾‘ï¼šæ£€æŸ¥ç”¨æˆ·è¯´çš„è¯ (text) é‡Œæ˜¯å¦åŒ…å«æŸä¸ªä¸­æ–‡å›½å®¶å
            for (let engKey in countryNameMap) {
                let cnName = countryNameMap[engKey];
                
                if (text.includes(cnName)) {
                    // æ‰¾åˆ°äº†ï¼
                    found = true;
                    matchedNameCN = cnName;

                    // ç‚¹äº®è¯¥æ¿å— (ä½¿ç”¨è‹±æ–‡Keyå»è§¦å‘ECharts)
                    triggerHighlight(engKey);
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœæ˜¯ä¸­å›½ï¼ŒæŠŠå°æ¹¾ä¹Ÿç‚¹äº®
                    if (cnName === "ä¸­å›½") {
                        triggerHighlight("Taiwan"); 
                    }
                    
                    // åªè¦åŒ¹é…åˆ°ä¸€ä¸ªå°±åœæ­¢å¾ªç¯å—ï¼Ÿå»ºè®®ä¸åœæ­¢ï¼Œé˜²æ­¢ç”¨æˆ·è¯´â€œæˆ‘æ¥è‡ªä¸­å›½å’Œç¾å›½â€
                    // ä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å…ˆå–ç¬¬ä¸€ä¸ªåŒ¹é…åˆ°çš„
                    break; 
                }
            }

            // 4. åé¦ˆä¸è‡ªåŠ¨ç†„ç­
            if (found) {
                msgBox.innerText = `ğŸ‘‹ æ¬¢è¿æ¥è‡ª ${matchedNameCN} çš„æœ‹å‹ï¼`;
                msgBox.style.color = "#ffcc00";
                msgBox.style.borderColor = "#ffcc00";

                // ã€æ ¸å¿ƒéœ€æ±‚ã€‘è®¾ç½®2ç§’åç†„ç­
                lightTimer = setTimeout(() => {
                    myChart.dispatchAction({ type: 'unselect', seriesIndex: 0 });
                    myChart.dispatchAction({ type: 'downplay', seriesIndex: 0 });
                    msgBox.innerText = "ğŸ¤ ç»§ç»­è†å¬ä¸­...";
                    msgBox.style.color = "#fff";
                    msgBox.style.borderColor = "#fff";
                }, 2000);

            } else {
                msgBox.innerText = `ğŸ¤” å¬åˆ°äº†: "${text}" (æœªæ‰¾åˆ°å›½å®¶)`;
                msgBox.style.color = "#00d0ff";
                msgBox.style.borderColor = "#00d0ff";
            }
        }

        function triggerHighlight(mapName) {
            // è§¦å‘é€‰ä¸­ (æ˜¾ç¤ºæ–‡å­— + é‡‘è‰²)
            myChart.dispatchAction({
                type: 'select',
                seriesIndex: 0,
                name: mapName
            });
            // è§¦å‘é«˜äº® (å¢å¼ºæ•ˆæœ)
            myChart.dispatchAction({
                type: 'highlight',
                seriesIndex: 0,
                name: mapName
            });
        }

        window.onresize = function() { myChart.resize(); };
    </script>
</body>
</html>
