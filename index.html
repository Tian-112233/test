<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å¹´æ—¥å†</title>
    <style>
        @import url('https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@500;700;900&display=swap');
        
        :root {
            --bg-wood: #2c1e14;
            --paper-base: #fcf8e8;
            --china-red: #b81c22;
            --gold: #e0b043;
            --ink: #1a1a1a;
        }

        body {
            background-color: var(--bg-wood);
            background-image: repeating-linear-gradient(90deg, #36251d 0, #36251d 2px, #2c1e14 0, #2c1e14 20px);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Noto Serif SC', serif;
            overflow: hidden; user-select: none;
            /* ç¦ç”¨é»˜è®¤ç‚¹å‡»é«˜äº® */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- è¯­éŸ³å¼€å…³ --- */
        .voice-switch {
            position: fixed; top: 20px; left: 20px; z-index: 999;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            display: flex; align-items: center; gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-size: 14px;
        }
        .voice-switch:hover { background: rgba(0,0,0,0.8); }
        .voice-switch.active {
            background: rgba(184, 28, 34, 0.9);
            border-color: #ff6666;
            box-shadow: 0 0 15px rgba(184, 28, 34, 0.5);
        }
        .wave-bars { display: flex; gap: 3px; height: 12px; align-items: center; }
        .bar { width: 3px; height: 100%; background: #fff; border-radius: 2px; animation: none; }
        .active .bar { animation: wave 0.6s infinite ease-in-out; } /* åŠ å¿«äº†åŠ¨ç”»é¢‘ç‡ */
        .active .bar:nth-child(1) { animation-delay: 0.0s; }
        .active .bar:nth-child(2) { animation-delay: 0.2s; }
        .active .bar:nth-child(3) { animation-delay: 0.4s; }
        .active .bar:nth-child(4) { animation-delay: 0.1s; }
        @keyframes wave { 0%, 100% { height: 4px; opacity: 0.5; } 50% { height: 16px; opacity: 1; } }

        /* --- æ¢å£çº¸æŒ‰é’® --- */
        .upload-corner {
            position: fixed; top: 20px; right: 20px;
            background: rgba(255,255,255,0.15);
            color: #fff; padding: 8px 15px; border-radius: 20px;
            font-size: 13px; cursor: pointer; z-index: 999;
            backdrop-filter: blur(5px); transition: background 0.3s;
        }
        .upload-corner:hover { background: rgba(255,255,255,0.3); }

        /* --- æ—¥å†ä¸»ä½“ --- */
        .calendar-scene {
            position: relative;
            width: 380px; height: 620px;
            perspective: 2500px;
            margin-top: 0;
        }

        .binder-bar {
            position: absolute; top: -15px; left: 15px; right: 15px; height: 45px;
            background: linear-gradient(to bottom, #444, #222);
            border-radius: 6px; z-index: 500;
            display: flex; justify-content: space-evenly;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer; /* æç¤ºå¯ç‚¹å‡» */
        }
        /* å¢åŠ ç‚¹å‡»æç¤º */
        .binder-bar:active { transform: translateY(2px); }
        .binder-bar::after {
            content: "â–² ä¸Šä¸€æœˆ";
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.3); font-size: 12px; pointer-events: none;
        }

        .ring {
            width: 12px; height: 50px;
            background: linear-gradient(to right, #ccc, #fff, #ccc);
            border-radius: 6px; margin-top: -8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        /* é¡µé¢æ ·å¼ */
        .page {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--paper-base);
            border-radius: 12px;
            border: 1px solid #e0d0b0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            transform-origin: top center;
            transform-style: preserve-3d;
            transition: transform 0.7s cubic-bezier(0.645, 0.045, 0.355, 1);
            display: flex; flex-direction: column;
            overflow: hidden;
            backface-visibility: hidden;
            cursor: pointer; /* æç¤ºå¯ç‚¹å‡» */
        }
        .page.flipped { transform: rotateX(-160deg); opacity: 0; pointer-events: none; }
        
        /* å¤´éƒ¨ */
        .header-section {
            height: 150px; background-color: var(--china-red);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .month-name {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 64px; color: var(--gold);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            line-height: 1;
        }
        .lunar-tag {
            color: rgba(255,255,255,0.9); margin-top: 8px; font-size: 16px;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 2px 12px; border-radius: 20px;
        }

        /* ç½‘æ ¼ */
        .grid-wrap { flex-grow: 1; padding: 20px; position: relative; }
        table { width: 100%; height: 100%; border-collapse: collapse; table-layout: fixed; }
        th { color: #886; font-size: 14px; height: 40px; }
        td {
            text-align: center; vertical-align: middle;
            font-size: 24px; font-weight: 700;
            color: var(--ink);
            border-radius: 50%; transition: background 0.2s;
            position: relative; z-index: 2;
        }
        /* ç‚¹å‡»æ—¥æœŸæ—¶çš„åé¦ˆ */
        td:active { background-color: rgba(184, 28, 34, 0.1); }
        td:nth-child(1), td:nth-child(7) { color: #c02c26; }

        /* å¢¨æ°´ */
        .ink-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
        }
        .ink-circle {
            fill: none; stroke: #c02c26; stroke-width: 3.5;
            stroke-linecap: round; stroke-linejoin: round;
            stroke-dasharray: 600; stroke-dashoffset: 600;
            animation: draw 0.6s ease-out forwards;
        }
        @keyframes draw { to { stroke-dashoffset: 0; } }

    </style>
</head>
<body>

    <div class="voice-switch" id="voice-btn" onclick="toggleVoice()">
        <div class="wave-bars">
            <div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div>
        </div>
        <span id="status-txt">ç‚¹å‡»å¼€å¯å£°æ§</span>
    </div>

    <label class="upload-corner">
        ğŸ–¼ï¸ æ›´æ¢å£çº¸
        <input type="file" id="img-uploader" accept="image/*" style="display:none">
    </label>

    <div class="calendar-scene" id="scene">
        <div class="binder-bar" onclick="prevMonth(event)">
            <div class="ring"></div><div class="ring"></div><div class="ring"></div>
            <div class="ring"></div><div class="ring"></div><div class="ring"></div>
        </div>
        </div>

    <script>
        const MONTHS_CN = ["ä¸€æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","åä¸€æœˆ","åäºŒæœˆ"];
        const LUNAR = ["è…Šæœˆ", "æ­£æœˆ", "ææœˆ", "æ¡ƒæœˆ", "æ§æœˆ", "è’²æœˆ", "è·æœˆ", "å…°æœˆ", "æ¡‚æœˆ", "èŠæœˆ", "éœ²æœˆ", "å†¬æœˆ"];
        const YEAR = 2026;

        let currentMonth = 1;
        let isAnimating = false;
        let recognition = null;
        let isVoiceOn = false;
        let lastCommandTime = 0; // å‘½ä»¤é˜²æŠ–æ—¶é—´æˆ³

        window.onload = () => {
            initCalendar();
            initUploader();
            try { new AudioContext(); } catch(e){}
        };

        // --- æ‰‹åŠ¨ç¿»é¡µé€»è¾‘ ---
        
        function nextMonth() {
            if(currentMonth < 12) {
                autoFlipTo(currentMonth + 1);
            } else {
                // å·²ç»åœ¨12æœˆï¼Œç»™ä¸ªè§†è§‰åé¦ˆ
                playTone('pen', 800); 
            }
        }

        function prevMonth(e) {
            e.stopPropagation(); // é˜²æ­¢å†’æ³¡è§¦å‘ nextMonth
            if(currentMonth > 1) {
                autoFlipTo(currentMonth - 1);
            } else {
                playTone('pen', 800); 
            }
        }

        // --- è¯­éŸ³é€»è¾‘ (ä¼˜åŒ–ç‰ˆï¼šå®æ—¶å“åº”) ---
        
        function toggleVoice() {
            const btn = document.getElementById('voice-btn');
            const txt = document.getElementById('status-txt');
            
            if(isVoiceOn) {
                isVoiceOn = false;
                if(recognition) recognition.stop();
                btn.classList.remove('active');
                txt.innerText = "ç‚¹å‡»å¼€å¯å£°æ§";
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRecognition) {
                alert("æŠ±æ­‰ï¼Œæ­¤æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³API (è¯·ä½¿ç”¨ Chrome/Safari)ã€‚");
                return;
            }

            if(!recognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = true;
                recognition.interimResults = true; // å…³é”®ä¿®æ”¹ï¼šå¼€å¯å®æ—¶ä¸­é—´ç»“æœ

                recognition.onend = () => {
                    if(isVoiceOn) {
                        try { recognition.start(); } catch(e){}
                    }
                };

                recognition.onerror = (e) => {
                    console.log("Voice Error:", e.error);
                    if(e.error === 'not-allowed') {
                        isVoiceOn = false;
                        btn.classList.remove('active');
                        txt.innerText = "æƒé™è¢«æ‹’";
                    }
                };

                recognition.onresult = (e) => {
                    // è·å–æœ€æ–°çš„è¯†åˆ«ç»“æœï¼ˆåŒ…å«ä¸­é—´ç»“æœï¼‰
                    const results = Array.from(e.results);
                    const transcript = results[results.length - 1][0].transcript;
                    
                    // å®æ—¶æ˜¾ç¤º
                    txt.innerText = transcript;
                    
                    // ç«‹å³å°è¯•è§£æï¼Œä¸ç­‰å¥å­ç»“æŸ
                    const success = parseCommand(transcript);
                    
                    if(success) {
                        // å¦‚æœæŒ‡ä»¤æˆåŠŸæ‰§è¡Œï¼Œé‡ç½®è¯†åˆ«æµä»¥é¿å…é‡å¤è§¦å‘
                        recognition.abort(); 
                        txt.innerText = "æŒ‡ä»¤å·²æ‰§è¡Œ";
                        setTimeout(() => { if(isVoiceOn) txt.innerText = "æ­£åœ¨è†å¬..."; }, 1200);
                    }
                };
            }

            try {
                recognition.start();
                isVoiceOn = true;
                btn.classList.add('active');
                txt.innerText = "æ­£åœ¨è†å¬...";
            } catch(e) { console.error(e); }
        }

        // --- æ™ºèƒ½æŒ‡ä»¤è§£æ (ä¼˜åŒ–ï¼šæ¨¡ç³ŠåŒ¹é…ä¸å»é‡) ---
        
        function parseCommand(str) {
            // é˜²æŠ–ï¼šå¦‚æœ500mså†…åˆšæ‰§è¡Œè¿‡æŒ‡ä»¤ï¼Œå¿½ç•¥
            if(Date.now() - lastCommandTime < 500) return false;

            // ç§»é™¤æ ‡ç‚¹ç¬¦å·ï¼Œç»Ÿä¸€å¤„ç†
            str = str.replace(/[ï¼Œã€‚ï¼Ÿï¼,.]/g, '');
            console.log("Detecting:", str);

            const map = {'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'åä¸€':11,'åäºŒ':12};
            let m = -1, d = -1;
            let actionTriggered = false;

            // 1. è§£ææœˆä»½ (ä¼˜å…ˆåŒ¹é…æœ«å°¾çš„â€œæœˆâ€)
            // åŒ¹é…æ­£åˆ™ï¼š(ä¸­æ–‡æ•°å­—|é˜¿æ‹‰ä¼¯æ•°å­—) + æœˆ
            let monthMatch = str.match(/([ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+|\d+)æœˆ/);
            
            if(monthMatch) {
                let mStr = monthMatch[1];
                if(map[mStr]) m = map[mStr];
                else m = parseInt(mStr);
            }

            // 2. è§£ææ—¥æœŸ
            // åŒ¹é…æ­£åˆ™ï¼š(ä¸­æ–‡æ•°å­—|é˜¿æ‹‰ä¼¯æ•°å­—) + (å·|æ—¥)
            if(m !== -1) {
                // ç®€å•çš„åˆ‡åˆ†ï¼Œåªçœ‹â€œæœˆâ€å­—åé¢çš„éƒ¨åˆ†
                let afterMonth = str.split('æœˆ')[1] || "";
                
                // å°è¯•è§£æä¸­æ–‡æ—¥æœŸ (å¦‚ï¼šäºŒåäº”)
                if(afterMonth.length > 0) {
                     // å¤„ç†ä¸­æ–‡å£è¯­ä¹ æƒ¯
                    const cnNums = "ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å";
                    
                    // 20-31
                    if(afterMonth.includes("ä¸‰å")) {
                        let end = afterMonth.split("ä¸‰å")[1];
                        d = 30 + (map[end && end[0]] || 0);
                    } else if(afterMonth.includes("äºŒå")) {
                        let end = afterMonth.split("äºŒå")[1];
                        d = 20 + (map[end && end[0]] || 0);
                    } else if(afterMonth.includes("å") && !afterMonth.startsWith("äºŒ") && !afterMonth.startsWith("ä¸‰")) {
                        // 10-19
                        let parts = afterMonth.split("å");
                        if(parts[0].length === 0) { // "å"å¼€å¤´
                            d = 10 + (map[parts[1] && parts[1][0]] || 0);
                        }
                    } else {
                        // 1-9 (æŸ¥æ‰¾å•ä¸ªæ•°å­—)
                        for(let k in map) {
                            if(afterMonth.includes(k+"å·") || afterMonth.includes(k+"æ—¥")) {
                                d = map[k];
                                break;
                            }
                        }
                    }
                    
                    // å¦‚æœä¸­æ–‡æ²¡åŒ¹é…åˆ°ï¼Œå°è¯•é˜¿æ‹‰ä¼¯æ•°å­—
                    if(d === -1) {
                        let dNum = afterMonth.match(/\d+/);
                        if(dNum) d = parseInt(dNum[0]);
                    }
                }
            }

            // æ‰§è¡Œé€»è¾‘
            if(m >= 1 && m <= 12) {
                // å¦‚æœåªè¯´äº†æœˆä»½ï¼Œä¸”æœˆä»½å˜äº†ï¼Œå°±ç¿»é¡µ
                if(m !== currentMonth) {
                    playTone('success');
                    autoFlipTo(m);
                    lastCommandTime = Date.now();
                    actionTriggered = true;
                }
                
                // å¦‚æœè¿˜è§£æå‡ºäº†æ—¥æœŸ
                if(d >= 1 && d <= 31) {
                    // ç¡®ä¿ç¿»é¡µåå†åœˆæ—¥æœŸ
                    if(!actionTriggered && m === currentMonth) {
                        // åŒæœˆä»½ç›´æ¥åœˆ
                        circleDate(m, d);
                        playTone('success');
                        lastCommandTime = Date.now();
                        actionTriggered = true;
                    } else {
                        // ä¸åŒæœˆä»½ï¼Œç¿»é¡µåå»¶æ—¶åœˆ
                        setTimeout(() => circleDate(m, d), 800);
                        // è¿™é‡Œ actionTriggered å·²ç»æ˜¯ true äº†
                    }
                }
                
                // å¦‚æœåªæ˜¯â€œäº”æœˆâ€ä¸”å·²ç»åœ¨äº”æœˆï¼Œä¹Ÿç®—æŒ‡ä»¤æˆåŠŸï¼ˆé˜²æ­¢é‡å¤è¯†åˆ«ï¼‰
                if(m === currentMonth && d === -1) {
                     // å¯é€‰ï¼šæ’­æ”¾ä¸ªæç¤ºéŸ³æˆ–è€…å¿½ç•¥
                     // actionTriggered = true; 
                }
            }

            return actionTriggered;
        }

        // --- æ—¥å†æ ¸å¿ƒ ---
        function initCalendar() {
            const container = document.getElementById('scene');
            for (let m = 12; m >= 1; m--) {
                const page = document.createElement('div');
                page.className = 'page';
                page.id = `page-${m}`;
                page.style.zIndex = 20 - m;
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼šç‚¹é¡µé¢å†…å®¹ -> ä¸‹ä¸€æœˆ
                page.onclick = (e) => {
                    // æ’é™¤ç‚¹å‡»åˆ°å…·ä½“æ—¥æœŸï¼ˆæ—¥æœŸæœ‰è‡ªå·±çš„onclickï¼‰çš„æƒ…å†µï¼Œè™½ç„¶æ—¥æœŸclickä¼šå†’æ³¡ï¼Œä½†æˆ‘ä»¬å¯ä»¥åœ¨æ—¥æœŸclické‡Œå¤„ç†
                    // è¿™é‡Œä¸»è¦å¤„ç†ç©ºç™½å¤„ç‚¹å‡»
                    nextMonth();
                };

                const lunarYear = (m === 1) ? "ä¹™å·³å¹´" : "ä¸™åˆå¹´";
                page.innerHTML = `
                    <div class="header-section">
                        <div class="month-name">${MONTHS_CN[m-1]}</div>
                        <div class="lunar-tag">${lunarYear} Â· ${LUNAR[m-1]}</div>
                    </div>
                    <div class="grid-wrap" id="wrap-${m}">
                        ${genGrid(YEAR, m)}
                        <svg class="ink-layer" id="ink-${m}" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
                    </div>
                `;
                container.appendChild(page);
            }
        }

        function genGrid(y, m) {
            const d = new Date(y, m - 1, 1);
            const days = new Date(y, m, 0).getDate();
            const start = d.getDay();
            let h = '<table><thead><tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr></thead><tbody><tr>';
            for(let i=0; i<start; i++) h+='<td></td>';
            for(let i=1; i<=days; i++){
                if((start+i-1)%7===0 && i!==1) h+='</tr><tr>';
                // stopPropagation é˜²æ­¢è§¦å‘æ•´é¡µçš„ç¿»é¡µ
                h+=`<td id="d-${m}-${i}" onclick="event.stopPropagation(); circleDate(${m},${i})">${i}</td>`;
            }
            h+='</tr></tbody></table>';
            return h;
        }

        async function autoFlipTo(target) {
            if(target === currentMonth || isAnimating) return;
            isAnimating = true;
            playTone('flip');

            if (target > currentMonth) {
                for (let i = currentMonth; i < target; i++) {
                    document.getElementById(`page-${i}`).classList.add('flipped');
                    await new Promise(r => setTimeout(r, 150));
                }
            } else {
                for (let i = currentMonth - 1; i >= target; i--) {
                    document.getElementById(`page-${i}`).classList.remove('flipped');
                    await new Promise(r => setTimeout(r, 150));
                }
            }
            currentMonth = target;
            isAnimating = false;
        }

        function circleDate(m, d) {
            if(m !== currentMonth) return;
            playTone('pen');
            const svg = document.getElementById(`ink-${m}`);
            const cell = document.getElementById(`d-${m}-${d}`);
            const wrap = document.getElementById(`wrap-${m}`);
            if(!cell) return;
            
            const cR = cell.getBoundingClientRect();
            const wR = wrap.getBoundingClientRect();
            
            const cx = ((cR.left - wR.left + cR.width/2) / wR.width) * 100;
            const cy = ((cR.top - wR.top + cR.height/2) / wR.height) * 100;
            const rx = (30 / wR.width) * 100;
            const ry = (30 / wR.height) * 100;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const noise = () => (Math.random()-0.5)*5;
            let p = `M ${cx+rx} ${cy} `;
            p += `Q ${cx+rx} ${cy+ry+noise()} ${cx} ${cy+ry+noise()} `;
            p += `Q ${cx-rx+noise()} ${cy+ry} ${cx-rx+noise()} ${cy} `;
            p += `Q ${cx-rx} ${cy-ry+noise()} ${cx} ${cy-ry+noise()} `;
            p += `Q ${cx+rx+noise()} ${cy-ry} ${cx+rx-1} ${cy-2} `;
            path.setAttribute("d", p);
            path.setAttribute("class", "ink-circle");
            svg.appendChild(path);
        }

        // --- éŸ³æ•ˆ ---
        function playTone(type, freqOverride) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'flip') {
                osc.type = 'triangle'; osc.frequency.value = 120;
                g.gain.setValueAtTime(0.4, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.2);
                osc.start(now); osc.stop(now + 0.2);
            } else if (type === 'pen') {
                osc.type = 'sine'; osc.frequency.value = freqOverride || 400;
                g.gain.setValueAtTime(0.1, now);
                g.gain.linearRampToValueAtTime(0, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, now);
                osc.frequency.linearRampToValueAtTime(800, now+0.1);
                g.gain.setValueAtTime(0.1, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }

        function initUploader() {
            document.getElementById('img-uploader').onchange = (e) => {
                if(e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = v => document.body.style.backgroundImage = `url('${v.target.result}')`;
                    r.readAsDataURL(e.target.files[0]);
                }
            }
        }
    </script>
</body>
</html><!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 å¹´æ—¥å† - å®Œç¾å•åœˆç‰ˆ</title>
    <style>
        @import url('https://gs.jurieo.com/gemini/fonts-googleapis/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@500;700;900&display=swap');
        
        :root {
            --bg-wood: #2c1e14;
            --paper-base: #fcf8e8; 
            --china-red: #b81c22;
            --gold: #e0b043;
            --ink: #1a1a1a;
        }

        body {
            background-color: var(--bg-wood);
            background-image: repeating-linear-gradient(90deg, #36251d 0, #36251d 2px, #2c1e14 0, #2c1e14 20px);
            margin: 0; height: 100vh;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            font-family: 'Noto Serif SC', serif;
            overflow: hidden; user-select: none;
        }

        /* --- è¯­éŸ³å¼€å…³ --- */
        .voice-switch {
            position: fixed; top: 20px; left: 20px; z-index: 999;
            pointer-events: auto;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            display: flex; align-items: center; gap: 10px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-size: 14px;
        }
        .voice-switch:hover { background: rgba(0,0,0,0.8); }
        .voice-switch.active {
            background: rgba(184, 28, 34, 0.9);
            border-color: #ff6666;
            box-shadow: 0 0 15px rgba(184, 28, 34, 0.5);
        }

        /* å£°æ³¢åŠ¨ç”» */
        .wave-bars { display: flex; gap: 3px; height: 12px; align-items: center; }
        .bar { width: 3px; height: 100%; background: #fff; border-radius: 2px; }
        .active .bar { animation: wave 0.8s infinite ease-in-out; }
        .active .bar:nth-child(1) { animation-delay: 0.0s; }
        .active .bar:nth-child(2) { animation-delay: 0.2s; }
        .active .bar:nth-child(3) { animation-delay: 0.4s; }
        .active .bar:nth-child(4) { animation-delay: 0.1s; }

        @keyframes wave {
            0%, 100% { height: 4px; opacity: 0.5; }
            50% { height: 16px; opacity: 1; }
        }

        /* --- æ¢å£çº¸ --- */
        .upload-corner {
            position: fixed; top: 20px; right: 20px;
            background: rgba(255,255,255,0.15);
            color: #fff; padding: 8px 15px; border-radius: 20px;
            font-size: 13px; cursor: pointer; z-index: 999;
            backdrop-filter: blur(5px); transition: background 0.3s;
        }
        .upload-corner:hover { background: rgba(255,255,255,0.3); }

        /* --- æ—¥å†ä¸»ä½“ --- */
        .calendar-scene {
            position: relative;
            width: 380px; height: 620px;
            perspective: 2500px;
            margin-top: 0;
        }

        .binder-bar {
            position: absolute; top: -15px; left: 15px; right: 15px; height: 36px;
            background: linear-gradient(to bottom, #444, #222);
            border-radius: 6px; z-index: 500;
            display: flex; justify-content: space-evenly;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .ring {
            width: 12px; height: 50px;
            background: linear-gradient(to right, #ccc, #fff, #ccc);
            border-radius: 6px; margin-top: -12px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
        }

        /* é¡µé¢æ ·å¼ */
        .page {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--paper-base);
            border-radius: 12px;
            border: 1px solid #e0d0b0;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            transform-origin: top center;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.645, 0.045, 0.355, 1);
            display: flex; flex-direction: column;
            overflow: hidden;
            backface-visibility: hidden;
        }
        .page.flipped { transform: rotateX(-160deg); opacity: 0; pointer-events: none; }

        /* å¤´éƒ¨äº¤äº’ */
        .header-section {
            height: 150px; background-color: var(--china-red);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            border-bottom-left-radius: 40px; border-bottom-right-radius: 40px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            cursor: pointer; position: relative;
        }
        .header-section::after {
            content: "â† ä¸Šæœˆ | ä¸‹æœˆ â†’";
            position: absolute; bottom: 8px;
            font-size: 10px; color: rgba(255,255,255,0.4); pointer-events: none;
        }

        .month-name {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 64px; color: var(--gold);
            text-shadow: 2px 2px 0 rgba(0,0,0,0.2);
            line-height: 1;
        }
        .lunar-tag {
            color: rgba(255,255,255,0.9); margin-top: 8px; font-size: 16px;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 2px 12px; border-radius: 20px;
        }

        /* ç½‘æ ¼ */
        .grid-wrap { flex-grow: 1; padding: 20px; position: relative; }
        table { width: 100%; height: 100%; border-collapse: collapse; table-layout: fixed; }
        th { color: #886; font-size: 14px; height: 40px; }
        td {
            text-align: center; vertical-align: middle;
            font-size: 24px; font-weight: 700;
            color: var(--ink); cursor: pointer;
            border-radius: 50%; transition: background 0.2s;
            position: relative; z-index: 2;
        }
        td:nth-child(1), td:nth-child(7) { color: #c02c26; }
        
        /* å¢¨æ°´ */
        .ink-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
        }
        .ink-circle {
            fill: none; stroke: #c02c26; stroke-width: 3.5;
            stroke-linecap: round; stroke-linejoin: round;
            stroke-dasharray: 600; stroke-dashoffset: 600;
            animation: draw 0.6s ease-out forwards;
        }
        @keyframes draw { to { stroke-dashoffset: 0; } }
    </style>
</head>
<body>

    <div class="voice-switch" id="voice-btn" onclick="toggleVoice()">
        <div class="wave-bars">
            <div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div>
        </div>
        <span id="status-txt">ç‚¹å‡»å¼€å¯å£°æ§</span>
    </div>

    <label class="upload-corner">
        ğŸ–¼ï¸ æ›´æ¢å£çº¸
        <input type="file" id="img-uploader" accept="image/*" style="display:none">
    </label>

    <div class="calendar-scene" id="scene">
        <div class="binder-bar">
            <div class="ring"></div><div class="ring"></div><div class="ring"></div>
            <div class="ring"></div><div class="ring"></div><div class="ring"></div>
        </div>
    </div>

    <script>
        const MONTHS_CN = ["ä¸€æœˆ","äºŒæœˆ","ä¸‰æœˆ","å››æœˆ","äº”æœˆ","å…­æœˆ","ä¸ƒæœˆ","å…«æœˆ","ä¹æœˆ","åæœˆ","åä¸€æœˆ","åäºŒæœˆ"];
        const LUNAR = ["è…Šæœˆ", "æ­£æœˆ", "ææœˆ", "æ¡ƒæœˆ", "æ§æœˆ", "è’²æœˆ", "è·æœˆ", "å…°æœˆ", "æ¡‚æœˆ", "èŠæœˆ", "éœ²æœˆ", "å†¬æœˆ"];
        const YEAR = 2026;

        let currentMonth = 1;
        let isAnimating = false;
        let recognition = null;
        let isVoiceOn = false; 
        
        // é˜²æŠ–è®¡æ—¶å™¨
        let debounceTimer = null; 

        window.onload = () => {
            initCalendar();
            initUploader();
            try { new AudioContext(); } catch(e){}
        };

        // --- æ‰‹åŠ¨ç¿»é¡µ ---
        function handleHeaderClick(e, m) {
            const rect = e.currentTarget.getBoundingClientRect();
            if (e.clientX - rect.left < rect.width / 2) {
                if (currentMonth > 1) autoFlipTo(currentMonth - 1);
                else playTone('pen');
            } else {
                if (currentMonth < 12) autoFlipTo(currentMonth + 1);
                else playTone('pen');
            }
        }

        // --- è¯­éŸ³é€»è¾‘ ---
        function toggleVoice() {
            const btn = document.getElementById('voice-btn');
            const txt = document.getElementById('status-txt');
            
            if(isVoiceOn) {
                isVoiceOn = false;
                if(recognition) recognition.stop();
                btn.classList.remove('active');
                txt.innerText = "ç‚¹å‡»å¼€å¯å£°æ§";
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if(!SpeechRecognition) {
                alert("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³APIï¼Œå»ºè®®ä½¿ç”¨ Chrome");
                return;
            }

            if(!recognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.continuous = true; 
                recognition.interimResults = true; 

                recognition.onend = () => {
                    if(isVoiceOn) try { recognition.start(); } catch(e){}
                };

                recognition.onresult = (e) => {
                    // 1. è·å–å½“å‰å¥å­çš„ å”¯ä¸€ç´¢å¼• (ResultIndex)
                    const idx = e.resultIndex; 
                    const result = e.results[idx];
                    const transcript = result[0].transcript;
                    
                    // 2. å°†ç´¢å¼•ä¼ ç»™è§£æå™¨ï¼Œä½œä¸ºâ€œèº«ä»½è¯â€
                    parseCommand(transcript, idx);
                    
                    txt.innerText = transcript.length > 8 ? "..." + transcript.slice(-8) : transcript;
                };
            }

            try {
                recognition.start();
                isVoiceOn = true;
                btn.classList.add('active');
                txt.innerText = "è†å¬ä¸­...";
            } catch(e) { console.error(e); }
        }

        function parseCommand(str, cmdId) {
            console.log("CMD:", str, "ID:", cmdId);
            const map = {'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6,'ä¸ƒ':7,'å…«':8,'ä¹':9,'å':10,'åä¸€':11,'åäºŒ':12};
            let m = -1, d = -1;

            // 1. è§£ææœˆä»½
            if(str.indexOf('æœˆ') > -1) {
                let p = str.substring(Math.max(0, str.lastIndexOf('æœˆ') - 3), str.lastIndexOf('æœˆ')); 
                if (p.includes("åä¸€") || p.includes("11")) m = 11;
                else if (p.includes("åäºŒ") || p.includes("12")) m = 12;
                else {
                    for(let k in map) { 
                        if(p.endsWith(k) && !p.endsWith("å"+k)) { m = map[k]; break; } 
                    }
                    if(m === -1) {
                        let num = p.match(/\d+/);
                        if(num) m = parseInt(num[0]);
                    }
                }
            }

            // 2. è§£ææ—¥æœŸ
            if(m !== -1) {
                let afterMonth = str.split('æœˆ')[1] || "";
                if (afterMonth.length > 0) {
                     if(afterMonth.includes("ä¸‰å")) {
                        d = 30 + (map[afterMonth.slice(-1)] || 0);
                        if(afterMonth.includes("ä¸‰åä¸€")) d = 31;
                    } else if(afterMonth.includes("äºŒå")) {
                        d = 20 + (map[afterMonth.replace("å·","").replace("æ—¥","").slice(-1)] || 0);
                    } else if(afterMonth.includes("å") && !afterMonth.startsWith("äºŒ") && !afterMonth.startsWith("ä¸‰")) {
                        d = 10 + (map[afterMonth.replace("å·","").replace("æ—¥","").slice(-1)] || 0);
                    } else {
                         let num = afterMonth.match(/\d+/);
                         if(num) d = parseInt(num[0]);
                         else {
                             for(let k in map) {
                                if(afterMonth.includes(k + "å·") || afterMonth.includes(k + "æ—¥")) d = map[k];
                             }
                         }
                    }
                }
            }

            // æ‰§è¡Œé€»è¾‘
            if(m >= 1 && m <= 12) {
                if (m !== currentMonth) {
                    autoFlipTo(m);
                }
                
                if(d >= 1 && d <= 31) {
                    // ä¾ç„¶ä¿ç•™ä¸€ç‚¹ç‚¹é˜²æŠ–ï¼Œè®©è§†è§‰æ›´å¹³æ»‘ï¼ˆé¿å…æ¯æ¯«ç§’éƒ½åœ¨ç”»ï¼‰
                    if(debounceTimer) clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        // ä¼ å…¥ cmdIdï¼Œç¡®ä¿åŒä¸€å¥è¯åªç•™ä¸€ä¸ªåœˆ
                        circleDate(m, d, cmdId);
                    }, 400); 
                }
            }
        }

        // --- æ—¥å†æ ¸å¿ƒ ---
        function initCalendar() {
            const container = document.getElementById('scene');
            for (let m = 12; m >= 1; m--) {
                const page = document.createElement('div');
                page.className = 'page';
                page.id = `page-${m}`;
                page.style.zIndex = 20 - m; 
                const lunarYear = (m === 1) ? "ä¹™å·³å¹´" : "ä¸™åˆå¹´";
                page.innerHTML = `
                    <div class="header-section" onclick="handleHeaderClick(event, ${m})">
                        <div class="month-name">${MONTHS_CN[m-1]}</div>
                        <div class="lunar-tag">${lunarYear} Â· ${LUNAR[m-1]}</div>
                    </div>
                    <div class="grid-wrap" id="wrap-${m}">
                        ${genGrid(YEAR, m)}
                        <svg class="ink-layer" id="ink-${m}" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
                    </div>
                `;
                container.appendChild(page);
            }
        }

        function genGrid(y, m) {
            const d = new Date(y, m - 1, 1);
            const days = new Date(y, m, 0).getDate();
            const start = d.getDay();
            let h = '<table><thead><tr><th>æ—¥</th><th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th></tr></thead><tbody><tr>';
            for(let i=0; i<start; i++) h+='<td></td>';
            for(let i=1; i<=days; i++){
                if((start+i-1)%7===0 && i!==1) h+='</tr><tr>';
                // æ‰‹åŠ¨ç‚¹å‡»æ²¡æœ‰cmdIdï¼Œä¼  'manual'
                h+=`<td id="d-${m}-${i}" onclick="circleDate(${m},${i}, 'manual')">${i}</td>`;
            }
            h+='</tr></tbody></table>';
            return h;
        }

        async function autoFlipTo(target) {
            if(target === currentMonth || isAnimating) return;
            if(target < 1 || target > 12) return;
            isAnimating = true;
            playTone('flip');

            if (target > currentMonth) {
                for (let i = currentMonth; i < target; i++) {
                    document.getElementById(`page-${i}`).classList.add('flipped');
                    await new Promise(r => setTimeout(r, 100));
                }
            } else {
                for (let i = currentMonth - 1; i >= target; i--) {
                    document.getElementById(`page-${i}`).classList.remove('flipped');
                    await new Promise(r => setTimeout(r, 100));
                }
            }
            currentMonth = target;
            isAnimating = false;
        }

        // --- æ ¸å¿ƒä¿®å¤ï¼šç»˜åˆ¶ä¸æ“¦é™¤ ---
        function circleDate(m, d, cmdId) {
            // ç¿»é¡µä¿æŠ¤
            if(isAnimating || m !== currentMonth) {
                if (m === currentMonth) setTimeout(() => circleDate(m, d, cmdId), 200);
                else autoFlipTo(m).then(() => setTimeout(() => circleDate(m, d, cmdId), 500));
                return;
            }

            const svg = document.getElementById(`ink-${m}`);
            
            // 1. ã€å…³é”®æ­¥éª¤ã€‘æ£€æŸ¥å¹¶ç§»é™¤åŒä¸€ä¸ªæŒ‡ä»¤IDäº§ç”Ÿè¿‡çš„æ—§åœˆ
            if (cmdId && cmdId !== 'manual') {
                const existing = svg.querySelectorAll(`[data-voice-id="${cmdId}"]`);
                existing.forEach(el => el.remove());
            }

            const cell = document.getElementById(`d-${m}-${d}`);
            const wrap = document.getElementById(`wrap-${m}`);
            if(!cell) return;
            
            playTone('pen'); // æ’­æ”¾éŸ³æ•ˆ

            const cR = cell.getBoundingClientRect();
            const wR = wrap.getBoundingClientRect();
            
            const cx = ((cR.left - wR.left + cR.width/2) / wR.width) * 100;
            const cy = ((cR.top - wR.top + cR.height/2) / wR.height) * 100;
            const rx = (30 / wR.width) * 100;
            const ry = (30 / wR.height) * 100;

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            const noise = () => (Math.random()-0.5)*5;
            let p = `M ${cx+rx} ${cy} `;
            p += `Q ${cx+rx} ${cy+ry+noise()} ${cx} ${cy+ry+noise()} `;
            p += `Q ${cx-rx+noise()} ${cy+ry} ${cx-rx+noise()} ${cy} `;
            p += `Q ${cx-rx} ${cy-ry+noise()} ${cx} ${cy-ry+noise()} `;
            p += `Q ${cx+rx+noise()} ${cy-ry} ${cx+rx-1} ${cy-2} `;
            
            path.setAttribute("d", p);
            path.setAttribute("class", "ink-circle");
            
            // 2. ã€å…³é”®æ­¥éª¤ã€‘æ‰“ä¸Šèº«ä»½è¯å·
            if (cmdId) {
                path.setAttribute("data-voice-id", cmdId);
            }
            
            svg.appendChild(path);
        }

        // --- éŸ³æ•ˆ ---
        function playTone(type) {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const g = ctx.createGain();
            osc.connect(g); g.connect(ctx.destination);
            const now = ctx.currentTime;

            if (type === 'flip') {
                osc.type = 'triangle'; osc.frequency.value = 120;
                g.gain.setValueAtTime(0.4, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'pen') {
                osc.type = 'sine'; osc.frequency.value = 400;
                g.gain.setValueAtTime(0.1, now);
                g.gain.linearRampToValueAtTime(0, now + 0.15);
                osc.start(now); osc.stop(now + 0.15);
            } else if (type === 'success') {
                osc.type = 'sine'; osc.frequency.setValueAtTime(500, now);
                osc.frequency.linearRampToValueAtTime(800, now+0.1);
                g.gain.setValueAtTime(0.1, now);
                g.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
                osc.start(now); osc.stop(now + 0.5);
            }
        }

        function initUploader() {
            document.getElementById('img-uploader').onchange = (e) => {
                if(e.target.files[0]) {
                    const r = new FileReader();
                    r.onload = v => document.body.style.backgroundImage = `url('${v.target.result}')`;
                    r.readAsDataURL(e.target.files[0]);
                }
            }
        }
    </script>
</body>
</html>

